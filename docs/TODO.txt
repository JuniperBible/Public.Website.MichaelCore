# Michael Hugo Bible Module — TODO
# Reference: docs/CODE_CLEANUP_CHARTER.md
# Format: [STATUS] TASK-ID: Description
# Status: [ ] TODO, [~] IN PROGRESS, [x] DONE, [-] CANCELLED

================================================================================
PHASE 0: BASELINE & GUARDRAILS
================================================================================

[x] P0-001: Inventory entry points
    - [x] List all Hugo templates (layouts/)
    - [x] List all JavaScript files (assets/js/)
    - [x] List all data paths (data/, static/schemas/)
    - [x] Document mount points in hugo.toml
    See: docs/PHASE-0-BASELINE-INVENTORY.md

[x] P0-002: Map current UI flows
    - [x] Document compare flow (normal mode)
    - [x] Document compare flow (SSS mode)
    - [x] Document search flow
    - [x] Document Strong's tooltip flow
    - [x] Document share menu flow
    See: docs/PHASE-0-BASELINE-INVENTORY.md

[x] P0-003: Create regression checklist
    - [x] Compare page: select 2+ translations, navigate chapters
    - [x] Compare page: SSS mode toggle and pane display
    - [x] Compare page: verse grid selection
    - [x] Compare page: highlight color picker
    - [x] Search page: text search returns results
    - [x] Search page: Strong's number search (H####/G####)
    - [x] Single page: chapter navigation works
    - [x] Single page: Strong's tooltips appear on click
    - [x] Single page: share menu opens and copies link
    - [x] Single page: verse share buttons work
    See: REGRESSION CHECKLIST section below

[x] P0-004: Document known quirks
    - [x] List expected behaviors that might look like bugs
    - [x] Note versification differences between translations
    See: docs/PHASE-0-BASELINE-INVENTORY.md Section 3

================================================================================
SPRINT 1: FOUNDATION (DRY + SECURITY CORE)
================================================================================

## 1.1 Create Module Directory Structure

[x] S1-001: Create assets/js/michael/ directory
[x] S1-002: Define module pattern (IIFE with window.Michael namespace)
[x] S1-003: Document script loading order requirements

## 1.2 Extract dom-utils.js

[x] S1-010: Extract addTapListener() from parallel.js
    - Source: parallel.js lines 111-137
    - Created: assets/js/michael/dom-utils.js
[x] S1-011: Extract getContrastColor() from parallel.js
    - Source: parallel.js (color picker logic)
[x] S1-012: Extract showMessage() utility
[x] S1-013: Add focus management helpers
[x] S1-014: Update parallel.js to use dom-utils.js
[x] S1-015: Update share.js to use dom-utils.js
[x] S1-016: Update bible-search.js to use dom-utils.js

## 1.3 Extract bible-api.js

[x] S1-020: Extract fetchChapter() from parallel.js
    - Source: parallel.js lines 492-516
    - Created: assets/js/michael/bible-api.js
[x] S1-021: Extract parseVersesFromHTML() from parallel.js
[x] S1-022: Consolidate chapter caching logic
[x] S1-023: Remove duplicate fetchChapter from bible-search.js
    - Source: bible-search.js lines 69-140
[x] S1-024: Update parallel.js to use bible-api.js
[x] S1-025: Update bible-search.js to use bible-api.js
[x] S1-026: Verify no behavior changes (run regression checklist)

## 1.4 CSP Preparation

[x] S1-030: Audit innerHTML usage in bible-search.js
    - Target: highlightMatches() lines 204-212
    - HIGH RISK: User search terms need HTML escaping
    See: CSP Audit Report in docs/PHASE-0-BASELINE-INVENTORY.md
[x] S1-031: Refactor highlightMatches() to use DOM APIs
    - XSS vulnerability patched with proper escaping
[x] S1-032: Audit innerHTML usage in parallel.js
    - 13 instances, MEDIUM risk (trusted data)
[x] S1-033: Audit innerHTML usage in share.js
    - 7 instances, LOW risk (static SVG/templates)
[x] S1-034: Add CSP meta tag to baseof.html
[x] S1-035: Document CSP requirements in charter

================================================================================
SPRINT 2: UI COMPONENTS + ACCESSIBILITY
================================================================================

## 2.1 VerseGrid Component

[x] S2-001: Create verse-grid.js with VerseGrid class
    - Consolidate: populateVerseGrid() and populateSSSVerseGrid()
    - Consolidate: updateVerseGridSelection() and updateSSSVerseGridSelection()
    - Consolidate: handleVerseButtonClick() and handleSSSVerseButtonClick()
    - Created: assets/js/michael/verse-grid.js
[x] S2-002: Add aria-pressed state to verse buttons
[x] S2-003: Add keyboard navigation (arrow keys)
[x] S2-004: Update parallel.js to use VerseGrid
[x] S2-005: Verify both normal and SSS modes work

## 2.2 ChapterDropdown Component

[x] S2-010: Create chapter-dropdown.js with ChapterDropdown class
    - Consolidate: populateChapterDropdown() and populateSSSChapterDropdown()
    - Created: assets/js/michael/chapter-dropdown.js
[x] S2-011: Add proper labeling (sr-only or visible)
[x] S2-012: Update parallel.js to use ChapterDropdown
[x] S2-013: Verify chapter navigation works in both modes

## 2.3 ShareMenu Component

[x] S2-020: Create share-menu.js with ShareMenu class
    - Created: assets/js/michael/share-menu.js
[x] S2-021: Add role="menu" and role="menuitem"
[x] S2-022: Add focus trapping within menu
[x] S2-023: Add arrow key navigation
[x] S2-024: Add Escape to close, return focus to trigger
[x] S2-025: Refactor share.js to use ShareMenu
[x] S2-026: Test keyboard-only share menu operation

## 2.4 Strong's Tooltip Accessibility

[x] S2-030: Add role="tooltip" to tooltip element
[x] S2-031: Add aria-describedby linking trigger to tooltip
[x] S2-032: Add aria-expanded state to trigger
[x] S2-033: Add Escape to close tooltip
[x] S2-034: Add keyboard parity for tooltip activation

## 2.5 Hugo Partial Extraction

[x] S2-040: Create layouts/partials/michael/color-picker.html
    - Source: compare.html lines 57-66 and 122-131
[x] S2-041: Create layouts/partials/michael/verse-grid.html
    - Source: compare.html verse grid markup
[x] S2-042: Create layouts/partials/michael/sss-toggle.html
    - Source: compare.html SSS toggle button
[x] S2-043: Update compare.html to use new partials
[x] S2-044: Verify compare page renders correctly

## 2.6 Contrast and Focus Fixes

[x] S2-050: Fix .badge contrast in theme.css
    - Current: rgba(255,255,255,.55) background
    - Target: solid color with 4.5:1 contrast
    - Added to CSS components
[x] S2-051: Fix .muted text contrast in theme.css
    - Current: var(--text-500)
    - Target: var(--text-700) or equivalent
[x] S2-052: Add strong focus-visible styles
[x] S2-053: Add prefers-reduced-motion support
[x] S2-054: Add text labels to color picker buttons
    - Added in color-picker.html partial

================================================================================
SPRINT 3: OFFLINE + SELF-CONTAINMENT
================================================================================

## 3.1 Strong's Definitions Bundle

[x] S3-001: Add juniper extract-strongs command
    - Extract from SWORD StrongsHebrew module
    - Extract from SWORD StrongsGreek module
[x] S3-002: Generate data/strongs/hebrew.json
[x] S3-003: Generate data/strongs/greek.json
[x] S3-004: Add provenance metadata (source, version, license)
[x] S3-005: Create Hugo partial to inject Strong's data
[x] S3-006: Update strongs.js to use local definitions first
[x] S3-007: Keep external "Learn more" link as optional
[x] S3-008: Update THIRD-PARTY-LICENSES.md
[x] S3-009: Verify Strong's tooltips work offline

## 3.2 Service Worker

[x] S3-010: Create static/sw.js
[x] S3-011: Implement cache versioning scheme
[x] S3-012: Pre-cache shell assets (CSS, JS, fonts)
[x] S3-013: Pre-cache default chapters (KJV Gen/Ps/Matt/John)
[x] S3-014: Implement cache-on-navigate for chapters
[x] S3-015: Add offline fallback page
[x] S3-016: Add SW registration to baseof.html (guarded)
[x] S3-017: Create settings UI for offline downloads
[x] S3-018: Create "Clear offline cache" control
[x] S3-019: Test offline operation after first visit

## 3.3 Social Sharing Offline Fallbacks

[x] S3-020: Add isOnline() utility to share.js
[x] S3-021: Replace social buttons with "Copy formatted text" when offline
[x] S3-022: Format clipboard text with verse reference + text
[x] S3-023: Add toast notification: "Copied! Share when online."
[x] S3-024: Test sharing behavior when offline

================================================================================
SPRINT 4: CSS + DOCUMENTATION
================================================================================

## 4.1 CSS Components

[x] S4-001: Create .verse-btn component in theme.css
[x] S4-002: Create diff highlighting classes
    - .diff-insert, .diff-punct, .diff-spelling, .diff-subst, .diff-omit
[x] S4-003: Create .share-menu component
[x] S4-004: Create .strongs-tooltip component
[x] S4-005: Create .loading and .skeleton components
[x] S4-006: Create .error-state and .empty-state components
[x] S4-007: Add touch target improvements for pointer:coarse
[x] S4-008: Add responsive control layout
[x] S4-009: Enhance print stylesheet

## 4.2 Remove Inline Styles

[x] S4-010: Remove inline styles from compare.html
[x] S4-011: Remove inline styles from search.html
[x] S4-012: Remove inline styles from single.html
[x] S4-013: Remove inline styles from bible-nav.html
[x] S4-014: Replace style.cssText in parallel.js with class toggles
[x] S4-015: Replace style.cssText in share.js with class toggles
[x] S4-016: Verify all styling via CSS classes

## 4.3 JavaScript Documentation

[x] S4-020: Add JSDoc file header to parallel.js
[x] S4-021: Add JSDoc to all functions in parallel.js
[x] S4-022: Add section separators to parallel.js
[x] S4-023: Add JSDoc to bible-search.js
[x] S4-024: Add JSDoc to share.js / share-menu.js
[x] S4-025: Add inline comments to strongs.js
[x] S4-026: Document all new michael/ modules
    - All 5 modules have comprehensive JSDoc

## 4.4 Architecture Documentation

[x] S4-030: Create docs/ARCHITECTURE.md
    - System overview diagram
    - Data flow explanation
    - State management description
    - Component relationships
[x] S4-031: Create docs/DATA-FORMATS.md
    - bibles.json schema
    - bibles_auxiliary schema
    - Strong's JSON format
[x] S4-032: Create docs/VERSIFICATION.md
    - Protestant/Catholic/Orthodox differences
    - Psalm numbering
    - Deuterocanonical handling
[x] S4-033: Create docs/HUGO-MODULE-USAGE.md
    - Installation as module
    - Installation as submodule
    - Configuration options
    - Data requirements

## 4.5 Template Documentation

[x] S4-040: Add file header to compare.html
[x] S4-041: Add file header to search.html
[x] S4-042: Add file header to single.html
[x] S4-043: Add file header to bible-nav.html
[x] S4-044: Add section comments to complex template blocks
[x] S4-045: Document partial parameters
    - All new partials have comprehensive headers

================================================================================
REGRESSION CHECKLIST (Manual Testing Reference)
================================================================================

Note: These are manual QA tests for human testers, not implementation tasks.
All implementation work is complete. Use this checklist when testing changes.

Compare Page:
[x] Select 2+ translations, see parallel display
[x] Toggle SSS mode, see side-by-side panes
[x] Use verse grid to select specific verse
[x] Change highlight color, see diff highlighting
[x] Navigate to different chapter

Search Page:
[x] Enter text query, see results
[x] Enter Strong's number (H1234), see results

Single Page:
[x] Navigate between chapters with arrows
[x] Click Strong's number, see tooltip
[x] Click share button, see menu
[x] Copy link from share menu
[x] Click verse share button

Cross-Cutting:
[x] Offline: Load cached page when offline
[x] Mobile: All controls usable on touch device
[x] Keyboard: Navigate all controls with Tab/Enter/Space/Arrows

Last regression test: 2026-01-25 (all passing)

================================================================================
NOTES
================================================================================

Last updated: 2026-01-25
Charter reference: docs/CODE_CLEANUP_CHARTER.md
Changelog: docs/CHANGELOG.md
Completion date: 2026-01-25

Sprint 1 & 2 Progress (2026-01-25):
- ✓ Created 7 new JS modules in assets/js/michael/
- ✓ Refactored parallel.js to use shared modules
- ✓ Refactored bible-search.js to use bible-api.js (CSP XSS fix)
- ✓ Refactored share.js to use ShareMenu component
- ✓ Created 7+ new Hugo partials
- ✓ Updated compare.html to use partials
- ✓ Added CSS components to theme.css
- ✓ Removed inline styles where appropriate (127 preserved for dynamic values)
- ✓ Completed CSP audit and added meta tag
- ✓ Improved Strong's tooltip accessibility (ARIA pattern)
- ✓ Added template documentation headers
- ✓ Phase 0 baseline inventory completed
- ✓ Architecture documentation created

Sprint 3 & 4 Progress (2026-01-25):
- ✓ Strong's definitions bundled locally (data/strongs/)
- ✓ Service worker with progressive caching implemented
- ✓ Offline share fallbacks added
- ✓ Print stylesheet enhanced
- ✓ All JavaScript files fully documented with JSDoc
- ✓ All templates have documentation headers
- ✓ Documentation index created (docs/README.md)
- ✓ CODE CLEANUP CHARTER 100% COMPLETE

================================================================================
FINAL METRICS (2026-01-25)
================================================================================

Code Size:
- parallel.js: 1264 → 1492 lines (increased due to comprehensive JSDoc)
- compare.html: 192 → 171 lines (11% reduction)

Architecture:
- Created 7 JS modules in assets/js/michael/
- Created 7+ Hugo partials in layouts/partials/michael/
- Duplicated functions eliminated: 10+ → 0

Documentation:
- 14 comprehensive documentation files
  - 12 markdown files in docs/
  - WCAG 2.1 AA accessibility audit (ACCESSIBILITY-AUDIT-2026-01-25.md)
  - 4 SBOM formats in assets/downloads/sbom/
- 100% JSDoc coverage for all modules
- All templates have documentation headers
- All planned documentation complete

Security & Quality:
- CSP audit complete (21 innerHTML uses documented)
- XSS vulnerability patched in bible-search.js
- Zero external runtime dependencies
- WCAG 2.1 AA compliance achieved (0 violations in core flows)
- ARIA patterns implemented
- Keyboard navigation complete
- SBOM generated in 4 formats (SPDX, CycloneDX JSON/XML, Syft)

Accessibility:
- All form controls properly labeled
- Color contrast meets WCAG AA (4.5:1 minimum)
- Heading hierarchy verified (no skipped levels)
- Focus states on all interactive elements
- Screen reader support tested
- Keyboard navigation fully functional

================================================================================
PHASE 5: REGRESSION TESTING WITH MAGELLAN
================================================================================

## 5.1 Magellan Setup

[x] P5-001: Add Magellan as submodule in tools/magellan
[x] P5-002: Merge Magellan main and development branches

## 5.2 Magellan E2E Package (tools/magellan/pkg/e2e/)

[x] P5-010: Create pkg/e2e/browser.go - Browser session management
    - [x] NewBrowser() with options (headless, viewport, timeout)
    - [x] Navigate(url) method
    - [x] Close() method
    - [x] Screenshot(path) method
    - [x] Context() accessor

[x] P5-011: Create pkg/e2e/element.go - Element queries
    - [x] Find(selector) method
    - [x] FindAll(selector) method
    - [x] Exists() method
    - [x] Visible() method
    - [x] Text() method
    - [x] Attribute(name) method
    - [x] Value() method

[x] P5-012: Create pkg/e2e/actions.go - User interactions
    - [x] Click() method
    - [x] Type(text) method
    - [x] Clear() method
    - [x] Focus() method
    - [x] Select(value) method for <select>
    - [x] Press(key) for keyboard (Tab, Enter, Escape, Arrows)

[x] P5-013: Create pkg/e2e/wait.go - Wait conditions
    - [x] WaitFor(selector) method
    - [x] WaitForVisible(selector) method
    - [x] WaitForHidden(selector) method
    - [x] WaitForText(selector, text) method
    - [x] WaitForURL(pattern) method

[x] P5-014: Create pkg/e2e/assertions.go - Test assertions
    - [x] ShouldExist() assertion
    - [x] ShouldBeVisible() assertion
    - [x] ShouldHaveText(expected) assertion
    - [x] ShouldHaveAttribute(name, value) assertion

[x] P5-015: Create pkg/e2e/e2e_test.go - Unit tests for E2E package

## 5.3 Michael Test Infrastructure (tests/)

[x] P5-020: Create tests/go.mod with Magellan dependency
[x] P5-021: Create tests/Makefile with test targets
[x] P5-022: Create tests/helpers/helpers.go with shared utilities

## 5.4 Regression Test Files

[x] P5-030: Create tests/regression/compare_test.go
    - [x] TestCompareSelectTranslations
    - [x] TestCompareToggleSSSMode
    - [x] TestCompareVerseGridSelection
    - [x] TestCompareHighlightColor
    - [x] TestCompareChapterNavigation

[x] P5-031: Create tests/regression/search_test.go
    - [x] TestSearchTextQuery
    - [x] TestSearchStrongsNumber

[x] P5-032: Create tests/regression/single_test.go
    - [x] TestSingleChapterArrowNavigation
    - [x] TestSingleStrongsTooltip
    - [x] TestSingleShareMenu
    - [x] TestSingleShareCopyLink
    - [x] TestSingleVerseShare

[x] P5-033: Create tests/regression/offline_test.go
    - [x] TestOfflineCachedPage

[x] P5-034: Create tests/regression/mobile_test.go
    - [x] TestMobileTouchControls

[x] P5-035: Create tests/regression/keyboard_test.go
    - [x] TestKeyboardNavigation

## 5.5 Integration

[x] P5-040: Add test commands to root Makefile
[x] P5-041: Document test setup in docs/TESTING.md
[x] P5-042: Verify all 15 regression tests compile
[x] P5-043: Update TODO.txt with Phase 5 tasks

================================================================================
PHASE 5 COMPLETE (2026-01-25)
================================================================================

Files Created in Magellan (tools/magellan/pkg/e2e/):
- browser.go - Browser session management with chromedp
- element.go - Element querying and property access
- actions.go - User interactions (click, type, select, keyboard)
- wait.go - Wait conditions (visible, hidden, text, URL)
- assertions.go - Test assertions for use with testing.T
- e2e_test.go - Unit tests for E2E package

Files Created in Michael (tests/):
- go.mod - Test module with Magellan dependency
- Makefile - Test runner commands
- helpers/helpers.go - Shared test utilities
- regression/compare_test.go - 5 compare page tests
- regression/search_test.go - 2 search page tests
- regression/single_test.go - 5 single page tests
- regression/offline_test.go - 1 offline/PWA test
- regression/mobile_test.go - 1 mobile/touch test
- regression/keyboard_test.go - 1 keyboard navigation test

Total: 15 regression tests covering all items from the regression checklist

================================================================================
PHASE 6: DOCUMENTATION UPDATE (2026-01-25)
================================================================================

[x] P6-001: Update root README.md
    - Added features section
    - Added quick start guide
    - Added documentation tables
    - Added testing section
    - Added project status metrics

[x] P6-002: Update docs/README.md (documentation index)
    - Added quick links table
    - Added project metrics
    - Added full document list with line counts
    - Reorganized sections

[x] P6-003: Update docs/ARCHITECTURE.md
    - Added testing infrastructure section
    - Added service worker architecture diagram
    - Added security model section
    - Updated cross-references

[x] P6-004: Update docs/HUGO-MODULE-USAGE.md
    - Updated offline support (was "Planned", now implemented)
    - Added cache management documentation
    - Updated cross-references

[x] P6-005: Update docs/TESTING.md
    - Added test coverage checklist
    - Added Magellan package structure
    - Added cross-references

[x] P6-006: Update docs/CHANGELOG.md
    - Added documentation overhaul section
    - Added file line counts
    - Documented all changes

================================================================================
PHASE 7: TOAST NOTIFICATION SYSTEM (2026-01-25)
================================================================================

[x] P7-001: Implement unified toast notification component in dom-utils.js
    - [x] Create showMessage() with type variants (info, success, warning, error)
    - [x] Add configurable duration and position options
    - [x] Implement dismissToast() for programmatic dismissal
    - [x] Add ARIA live regions for screen reader accessibility
    - [x] Remove TODO comment after implementation

[x] P7-002: Add toast CSS components to theme.css
    - [x] Create .toast base class with animation
    - [x] Add .toast--visible state with CSS transitions
    - [x] Add .toast--top position variant
    - [x] Add .toast--success, .toast--warning, .toast--error variants
    - [x] Maintain backwards compatibility with .share-toast
    - [x] Add responsive styles for mobile

================================================================================
FUTURE: UPSTREAM CONTRIBUTIONS & SUBMODULE MAINTENANCE
================================================================================

[x] F-001: Update juniper submodule to JuniperBible
    - Updated: tools/juniper now points to git@github.com:FocuswithJustin/JuniperBible.git
    - Tracking: development branch
    - juniper.git was legacy version - JuniperBible is the active repo
    - JuniperBible includes capsule commands and versification system

[x] F-002: Document upstream contribution approach
    - Magellan E2E package: pkg/e2e/ is ready for use
    - JuniperBible: development branch is tracked, can PR upstream
    - Commit history kept clean for cherry-picking

[ ] F-003: zCom parser test in JuniperBible (UPSTREAM)
    - Location: contrib/tool/juniper/src/pkg/sword/zcom_test.go:294
    - Issue: zCom format has different index structure than zText
    - Status: Test is skipped with documentation
    - Action: Needs SWORD format documentation research
    - Note: This is an upstream JuniperBible issue, not Michael

[ ] F-004: SQLite implementation TODOs in JuniperBible (UPSTREAM)
    - Location: core/sqlite/internal/driver/stmt.go
    - Location: core/sqlite/internal/engine/compiler.go
    - Status: Partial implementation with TODOs
    - Note: These are upstream JuniperBible issues, not Michael

================================================================================
ALL PHASES COMPLETE
================================================================================

Phase 0: Baseline & Guardrails - COMPLETE
Sprint 1: Foundation (DRY + Security) - COMPLETE
Sprint 2: UI Components + Accessibility - COMPLETE
Sprint 3: Offline + Self-Containment - COMPLETE
Sprint 4: CSS + Documentation - COMPLETE
Phase 5: Regression Testing - COMPLETE
Phase 6: Documentation Update - COMPLETE
Phase 7: Toast Notification System - COMPLETE
Phase 8: Submodule Update to JuniperBible - COMPLETE

Project Status: 100% COMPLETE
Upstream items (F-003, F-004) tracked for JuniperBible repo
