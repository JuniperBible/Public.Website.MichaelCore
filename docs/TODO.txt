================================================================================
MICHAEL BIBLE PWA - PRODUCTION IMPLEMENTATION PLAN
================================================================================
Created: 2026-01-26
Status: IN PROGRESS
Goal: Transform Michael Bible into a fully installable, offline-first PWA

================================================================================
PHASE 1: CORE PWA INFRASTRUCTURE (Critical for Installability)
================================================================================

[ ] 1.1 Create Web App Manifest
    [ ] 1.1.1 Create static/manifest.json with required fields
          - name, short_name, description
          - start_url: "/"
          - scope: "/"
          - display: "standalone"
          - orientation: "portrait-primary"
          - background_color, theme_color
          - lang, dir
    [ ] 1.1.2 Add icons array (references to icon files)
    [ ] 1.1.3 Add shortcuts for quick actions (Read Bible, Compare, Search)
    [ ] 1.1.4 Add categories: ["books", "education", "lifestyle"]
    [ ] 1.1.5 Validate manifest with https://manifest-validator.appspot.com/

[ ] 1.2 Create App Icons
    [ ] 1.2.1 Create static/icons/ directory
    [ ] 1.2.2 Create icon-192x192.png (required minimum)
    [ ] 1.2.3 Create icon-512x512.png (required for splash screens)
    [ ] 1.2.4 Create icon-maskable-192x192.png (Android adaptive icons)
    [ ] 1.2.5 Create icon-maskable-512x512.png
    [ ] 1.2.6 Create apple-touch-icon.png (180x180 for iOS)
    [ ] 1.2.7 Create favicon.ico (multi-size: 16, 32, 48)
    [ ] 1.2.8 Create favicon-16x16.png
    [ ] 1.2.9 Create favicon-32x32.png
    [ ] 1.2.10 Create mstile-144x144.png (Windows tiles)
    [ ] 1.2.11 Create safari-pinned-tab.svg (Safari pinned tabs)
    Note: Icons should feature a book/Bible symbol, work on light/dark backgrounds

[ ] 1.3 Add PWA Meta Tags to baseof.html
    [ ] 1.3.1 Add <link rel="manifest" href="/manifest.json">
    [ ] 1.3.2 Add <meta name="theme-color" content="#...">
    [ ] 1.3.3 Add <meta name="apple-mobile-web-app-capable" content="yes">
    [ ] 1.3.4 Add <meta name="apple-mobile-web-app-status-bar-style" content="default">
    [ ] 1.3.5 Add <meta name="apple-mobile-web-app-title" content="Michael">
    [ ] 1.3.6 Add <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    [ ] 1.3.7 Add <meta name="msapplication-TileColor" content="#...">
    [ ] 1.3.8 Add <meta name="msapplication-TileImage" content="/icons/mstile-144x144.png">
    [ ] 1.3.9 Add favicon links (ico, 16x16, 32x32)
    [ ] 1.3.10 Update CSP to allow manifest loading

================================================================================
PHASE 2: INSTALL PROMPT & USER EXPERIENCE
================================================================================

[ ] 2.1 Implement Install Prompt Handling
    [ ] 2.1.1 Create assets/js/michael/pwa-install.js
          - Capture beforeinstallprompt event
          - Store deferred prompt
          - Export showInstallPrompt() function
          - Track install outcome (accepted/dismissed)
          - Handle appinstalled event
    [ ] 2.1.2 Create install prompt UI component
          - Non-intrusive banner or button
          - Accessible (ARIA labels, keyboard nav)
          - Dismissible with "don't show again" option
          - Responsive design
    [ ] 2.1.3 Add install button to offline-settings.html partial
    [ ] 2.1.4 Add iOS-specific install instructions (manual add to home screen)
    [ ] 2.1.5 Store user preference in localStorage

[ ] 2.2 Create Install Instructions Page
    [ ] 2.2.1 Create content/install.md or static page
    [ ] 2.2.2 Add platform-specific instructions (Android, iOS, Desktop)
    [ ] 2.2.3 Add screenshots/diagrams for each platform
    [ ] 2.2.4 Link from footer or help section

[ ] 2.3 Enhance Update Notification UI
    [ ] 2.3.1 Style sw-update-banner in theme.css
    [ ] 2.3.2 Add animation for banner appearance
    [ ] 2.3.3 Improve accessibility of update banner
    [ ] 2.3.4 Add "What's New" link option

================================================================================
PHASE 3: ENHANCED OFFLINE CAPABILITIES
================================================================================

[ ] 3.1 Improve Service Worker Pre-caching
    [ ] 3.1.1 Pre-cache critical CSS (handle fingerprinted filenames)
          - Use Hugo to generate asset manifest
          - Or use runtime caching with stale-while-revalidate
    [ ] 3.1.2 Pre-cache critical JS files
    [ ] 3.1.3 Pre-cache fonts if any are used
    [ ] 3.1.4 Add app shell HTML to pre-cache
    [ ] 3.1.5 Cache manifest.json and icons

[ ] 3.2 Add Stale-While-Revalidate Strategy
    [ ] 3.2.1 Implement SWR for static assets in sw.js
    [ ] 3.2.2 Update cache in background while serving cached version
    [ ] 3.2.3 Add cache expiration/cleanup for old assets

[ ] 3.3 Implement Background Sync (Optional but Recommended)
    [ ] 3.3.1 Register sync event in service worker
    [ ] 3.3.2 Queue failed download operations
    [ ] 3.3.3 Retry downloads when back online
    [ ] 3.3.4 Notify user of sync completion

[ ] 3.4 Add IndexedDB for User Data (Optional)
    [ ] 3.4.1 Create assets/js/michael/offline-storage.js
    [ ] 3.4.2 Implement reading progress storage
          - Last read chapter per Bible
          - Scroll position
          - Timestamp
    [ ] 3.4.3 Implement bookmarks storage
    [ ] 3.4.4 Implement notes/highlights storage (if feature exists)
    [ ] 3.4.5 Sync with service worker cache

[ ] 3.5 Offline Search Capability (Optional)
    [ ] 3.5.1 Pre-build search index for cached Bibles
    [ ] 3.5.2 Store search index in IndexedDB
    [ ] 3.5.3 Implement client-side search when offline
    [ ] 3.5.4 Fall back to server search when online

================================================================================
PHASE 4: TESTING
================================================================================

[ ] 4.1 Unit Tests for JavaScript Modules
    [ ] 4.1.1 Set up test framework (Jest or Vitest)
    [ ] 4.1.2 Create tests/js/ directory structure
    [ ] 4.1.3 Test offline-manager.js
          - initialize() - SW registration
          - downloadBible() - success, failure, cancellation
          - getCacheStatus() - returns correct format
          - getBibleCacheStatus() - per-Bible status
          - cancelDownload() - cancellation works
          - clearCache() - cache cleared
          - Event dispatching (progress, complete, cleared)
          - Timeout handling
    [ ] 4.1.4 Test pwa-install.js
          - beforeinstallprompt capture
          - showInstallPrompt() triggers prompt
          - Install outcome tracking
          - iOS detection and fallback
    [ ] 4.1.5 Test offline-settings-ui.js
          - UI initialization
          - Checkbox handling
          - Progress updates
          - Error messages

[ ] 4.2 Service Worker Tests
    [ ] 4.2.1 Test install event - assets pre-cached
    [ ] 4.2.2 Test activate event - old caches deleted
    [ ] 4.2.3 Test fetch strategies
          - Cache-first for static assets
          - Network-first for chapters
          - Offline fallback for navigation
    [ ] 4.2.4 Test message handlers
          - CACHE_BIBLE
          - GET_CACHE_STATUS
          - CLEAR_CACHE
          - CANCEL_DOWNLOAD
    [ ] 4.2.5 Test extractBookLinks() with various HTML formats
    [ ] 4.2.6 Test extractChapterLinks() with various HTML formats

[ ] 4.3 Integration Tests
    [ ] 4.3.1 Set up Playwright or Puppeteer
    [ ] 4.3.2 Test full download flow
          - Select Bible, click download
          - Verify progress updates
          - Verify completion
          - Verify cached chapters accessible offline
    [ ] 4.3.3 Test offline navigation
          - Go offline (network throttling)
          - Navigate to cached chapter
          - Verify content displays
          - Navigate to uncached page
          - Verify offline fallback shows
    [ ] 4.3.4 Test cache clearing
    [ ] 4.3.5 Test download cancellation
    [ ] 4.3.6 Test SW update flow

[ ] 4.4 PWA Audit Tests
    [ ] 4.4.1 Run Lighthouse PWA audit
    [ ] 4.4.2 Verify all PWA criteria pass:
          - Installable
          - PWA Optimized
          - Fast and reliable
    [ ] 4.4.3 Test on real devices
          - Android Chrome
          - iOS Safari
          - Desktop Chrome/Edge/Firefox
    [ ] 4.4.4 Test install flow on each platform

[ ] 4.5 Accessibility Tests
    [ ] 4.5.1 Keyboard navigation for install UI
    [ ] 4.5.2 Screen reader compatibility
    [ ] 4.5.3 Focus management
    [ ] 4.5.4 Color contrast

[ ] 4.6 Performance Tests
    [ ] 4.6.1 Measure cache operation performance
    [ ] 4.6.2 Test with large Bible downloads
    [ ] 4.6.3 Test memory usage during downloads
    [ ] 4.6.4 Test startup time after install

================================================================================
PHASE 5: DOCUMENTATION & POLISH
================================================================================

[ ] 5.1 Update Documentation
    [ ] 5.1.1 Document PWA features in README or docs
    [ ] 5.1.2 Document offline capabilities
    [ ] 5.1.3 Document install process for users
    [ ] 5.1.4 Document development setup for contributors

[ ] 5.2 Add PWA Screenshots for Install Prompt
    [ ] 5.2.1 Create screenshot-narrow.png (phone, 540x720)
    [ ] 5.2.2 Create screenshot-wide.png (tablet/desktop, 720x540)
    [ ] 5.2.3 Add to manifest.json screenshots array

[ ] 5.3 Final Polish
    [ ] 5.3.1 Review all console.log statements (remove or guard)
    [ ] 5.3.2 Ensure graceful degradation without JS
    [ ] 5.3.3 Test with slow 3G network throttling
    [ ] 5.3.4 Verify no CORS issues
    [ ] 5.3.5 Verify CSP allows all PWA resources

================================================================================
PHASE 6: DEPLOYMENT CHECKLIST
================================================================================

[ ] 6.1 Pre-deployment Verification
    [ ] 6.1.1 All Lighthouse PWA checks pass
    [ ] 6.1.2 Manifest validates without errors
    [ ] 6.1.3 Icons display correctly at all sizes
    [ ] 6.1.4 Install works on Android, iOS, Desktop
    [ ] 6.1.5 Offline mode works completely
    [ ] 6.1.6 No console errors in production build

[ ] 6.2 Server Configuration
    [ ] 6.2.1 Verify HTTPS is enforced
    [ ] 6.2.2 Verify correct MIME types for manifest and SW
    [ ] 6.2.3 Add Cache-Control headers for static assets
    [ ] 6.2.4 Consider HTTP/2 push for critical assets

================================================================================
NOTES & DECISIONS
================================================================================

Theme Colors (TBD - check existing design):
- Primary: #0A1922 (dark) or appropriate brand color
- Background: #ffffff (light mode), #1a1a1a (dark mode)

Icon Design (TBD):
- Should feature book/Bible imagery
- Must be recognizable at small sizes
- Consider using existing logo if available

Dependencies:
- No new npm dependencies required for core PWA
- Jest/Vitest for testing (optional, can use existing test setup)
- Playwright/Puppeteer for E2E tests (optional)

Browser Support:
- Chrome 67+ (full PWA)
- Firefox 67+ (limited PWA, no install prompt)
- Safari 11.1+ (limited PWA, no install prompt)
- Edge 79+ (full PWA, Chromium-based)

================================================================================
PROGRESS LOG
================================================================================

[2026-01-26] Plan created
  - Analyzed current codebase
  - Identified missing PWA components
  - Created comprehensive task list

[2026-01-26] PWA Implementation COMPLETED
  - Phase 1 DONE: Created manifest.json with icons, shortcuts, categories
  - Phase 1 DONE: Added PWA meta tags to baseof.html (manifest, theme-color, apple-mobile-web-app)
  - Phase 9 DONE: Created SVG logo (shield + sword + crown design)
  - Phase 9 DONE: Generated PNG icons at all required sizes (16, 32, 180, 192, 512, maskable)
  - Phase 2 DONE: Migrated sw.js to Hugo template (layouts/_default/sw.js)
    * CSS fingerprinting now works - cache version auto-updates with CSS changes
    * Added manifest.json and icons to pre-cache list
  - Phase 3 DONE: Created install prompt UI
    * pwa-install.js handles beforeinstallprompt event
    * pwa-install-banner.html partial with Install/Dismiss buttons
    * iOS-specific instructions for manual install
    * CSS styles in theme.css
  - Phase 6 DONE: Added background sync for downloads
    * Service worker handles 'sync' events
    * offline-manager.js can queue failed downloads
    * Downloads resume automatically when back online
  - Phase 7 DONE: Implemented IndexedDB user storage (user-storage.js)
    * Reading progress (per-Bible scroll position, last chapter)
    * Bookmarks storage
    * Notes/highlights storage
    * User settings/preferences
  - Phase 8 DONE: Added competitive features
    * reading-tracker.js for auto-saving progress
    * Reading streaks tracking
    * "Continue Reading" functionality

  Files created:
  - static/manifest.json
  - static/icons/logo.svg, logo-maskable.svg
  - static/icons/icon-16.png, icon-32.png, icon-192.png, icon-512.png
  - static/icons/icon-maskable-512.png, apple-touch-icon.png
  - layouts/_default/sw.js (Hugo template)
  - assets/js/michael/pwa-install.js
  - assets/js/michael/user-storage.js
  - assets/js/michael/reading-tracker.js
  - layouts/partials/michael/pwa-install-banner.html

  Files modified:
  - layouts/_default/baseof.html (PWA meta tags, install banner partial)
  - hugo.toml (added SW output format)
  - assets/css/theme.css (install banner styles)
  - assets/js/michael/offline-manager.js (background sync support)

  Files deleted:
  - static/sw.js (replaced by Hugo template)

[2026-01-26] PWA E2E Tests COMPLETED
  - Created comprehensive test suite: tests/regression/pwa_test.go
  - Added PWA test helpers to tests/helpers/helpers.go
  - Added make test-pwa target to Makefile

  Test Coverage (60+ tests):
  MANIFEST TESTS:
  - TestManifestExists - verifies manifest.json accessible
  - TestManifestRequiredFields - checks name, short_name, start_url, display, etc.
  - TestManifestIconSizes - verifies 192x192 and 512x512 icons
  - TestManifestMaskableIcon - checks maskable icon for Android

  ICON TESTS:
  - TestPWAIconsAccessible - all icon files return HTTP 200
  - TestSVGLogoExists - verifies logo.svg exists and is valid

  META TAG TESTS:
  - TestPWAMetaTags - manifest link, theme-color, apple-* tags, favicons

  SERVICE WORKER TESTS:
  - TestServiceWorkerExists - sw.js accessible with install/fetch handlers
  - TestServiceWorkerHasFingerprintedCSS - CSS path is fingerprinted
  - TestServiceWorkerRegistration - SW registers on page load
  - TestServiceWorkerActivation - SW activates and claims clients
  - TestServiceWorkerPrecache - shell cache created
  - TestServiceWorkerSyncHandler - sync event handler present

  OFFLINE TESTS:
  - TestOfflineFallbackPage - offline fallback for uncached pages
  - TestOfflineWithCachedCSS - CSS loads from cache when offline
  - TestBibleDownloadFlow - download workflow initiation
  - TestDownloadCancellation - cancelDownload API available
  - TestCacheStatusAPI - getCacheStatus returns valid data

  INSTALL PROMPT TESTS:
  - TestInstallBannerExists - banner element in DOM
  - TestInstallBannerHiddenByDefault - starts with hidden class
  - TestIOSInstructionsBanner - iOS instructions present
  - TestPWAInstallAPI - canInstall, triggerInstallPrompt, isPWAInstalled, isIOS

  INDEXEDDB STORAGE TESTS:
  - TestUserStorageAPI - all storage functions available
  - TestIndexedDBSupported - isSupported returns true
  - TestUserStorageReadingProgress - save/retrieve progress
  - TestUserStorageBookmarks - add/retrieve bookmarks
  - TestUserStorageSettings - save/retrieve with defaults

  READING TRACKER TESTS:
  - TestReadingTrackerAPI - init, getStreakInfo, getLastRead, etc.
  - TestReadingTrackerAutoSave - progress auto-saved on chapter pages
  - TestReadingStreak - streak tracking works

  BACKGROUND SYNC TESTS:
  - TestBackgroundSyncAPI - sync functions available
  - TestServiceWorkerSyncHandler - SW has sync handler

  CSS/ACCESSIBILITY TESTS:
  - TestInstallBannerStyles - CSS positioning correct
  - TestInstallBannerAccessibility - ARIA attributes present
  - TestOfflineMessagesAccessibility - messages container exists

  MOBILE TESTS:
  - TestMobilePWAMetaTags - viewport and apple-* tags
  - TestMobileInstallBanner - banner works on mobile

  ERROR HANDLING TESTS:
  - TestOfflineManagerErrorHandling - handles missing Bible
  - TestUserStorageErrorHandling - returns null/default for missing data

[2026-01-26] PWA Integration COMPLETED
  - Fixed script loading: Using Hugo resources.Get for JS files in baseof.html
  - Fixed pwa-install-banner.html to use Hugo resources.Get
  - Updated offline.html with Michael branding (colors, logo, accent colors)
  - Created Continue Reading UI component
    * layouts/partials/michael/continue-reading.html
    * CSS styles in theme.css (.continue-reading)
    * Integrated with reading-tracker.js
    * Shows on home page when user has reading history
  - All JS modules properly loaded via Hugo asset pipeline
  - Service worker pre-caches all required assets

  Files created:
  - layouts/partials/michael/continue-reading.html

  Files modified:
  - layouts/_default/baseof.html (proper resources.Get for JS)
  - layouts/partials/michael/pwa-install-banner.html (proper resources.Get)
  - layouts/index.html (include continue-reading partial)
  - static/offline.html (Michael branding, logo, theme colors)
  - assets/css/theme.css (continue-reading styles)

================================================================================
