================================================================================
MICHAEL BIBLE PWA - PLANNED TASKS
================================================================================
Updated: 2026-02-13

================================================================================
COMPLETED SPRINT #3: Security, Accessibility & Robustness (2026-02-13)
================================================================================

### Batch 1: JavaScript Null Safety [COMPLETED]
[x] Add null guards to theme-toggle.js DOM element access
[x] Add HTML escaping for XSS protection in chapter-reader.js renderAlignedVerses()
[x] Add null check for OfflineManager in offline-settings-ui.js
[x] Add try-catch and validation for localStorage in pwa-install.js isDismissed()
[x] Add null guards for DOM elements in pwa-install.js setupBannerUI()
[x] Add menuItems array validation in share-menu.js focus methods

### Batch 2: JavaScript Memory Leak Fixes [COMPLETED]
[x] Add cleanup handler for click listener in theme-toggle.js
[x] Add footnoteListeners tracking array and cleanup() in footnotes.js
[x] Add named handlers and cleanup() in reading-tracker.js
[x] Add tapListeners tracking and cleanup() in dom-utils.js

### Batch 3: Hugo Template Security & Nil Safety [COMPLETED]
[x] Fix XSS in sw-register.html - use DOM methods instead of innerHTML
[x] Add $bibleData nil checks in bible/single.html
[x] Add $bookData nil check in bible-nav.html
[x] Add configurable basePath to continue-reading.html (via data attribute)

### Batch 4: CSS Dark Mode Contrast & Accessibility [COMPLETED]
[x] Fix toast background colors for WCAG AA contrast (theme-colors.css)
[x] Fix diff highlight colors for 4.5:1 contrast ratio
[x] Lighten dark mode text colors (--text-500, --text-400)
[x] Add focus-visible state for reader toggles (theme-custom.css)
[x] Add prefers-reduced-motion for SSS verse row transitions
[x] Replace hardcoded rgba colors with CSS variables (theme-pwa.css)
[x] Add prefers-reduced-motion for offline message animation
[x] Increase tile touch targets from 40px to 44px (WCAG minimum)

### Batch 5: Service Worker Cache & Error Handling [COMPLETED]
[x] Move skipWaiting() after successful cache in install event
[x] Add offline.html fallback for HTML requests in cache-first errors
[x] Add offline.html fallback for HTML requests in network-first errors
[x] Add path validation for static asset caching
[x] Add retry tracking for background sync (MAX_SYNC_RETRIES = 3)

### Batch 6: PWA Install & Offline Improvements [COMPLETED]
[x] Add user feedback when install prompt unavailable in pwa-install.js
[x] Add isUserBusy() check before SW reload in offline-manager.js
[x] Add 7-day TTL for background sync localStorage entries
[x] Add comprehensive isNetworkRelatedError() detection
[x] Return false/null from user-storage.js on QuotaExceededError

### Batch 7: Build Scripts & Config Hardening [COMPLETED]
[x] Remove vendor-package from Makefile build target
[x] Add Hugo server startup verification in Makefile test target
[x] Make pkill more specific with port matching
[x] Make RELEASE confirmation case-insensitive
[x] Add README existence check in check-all.sh
[x] Capture stderr separately for debugging in check-all.sh
[x] Add --quiet flag documentation and parsing to generate-sbom.sh

### Batch 8: Form Accessibility & ARIA Fixes [COMPLETED]
[x] Add error announcer region in search.html
[x] Add role="region" to search results container
[x] Add aria-live to cache status and progress elements (offline-settings.html)
[x] Improve color picker button aria-labels
[x] Add data-pwa-banner for JS aria-hidden toggling

================================================================================
COMPLETED SPRINT #2: Post-ES6 Cleanup (2026-02-13)
================================================================================

### Batch 1: Complete ES6 Migration (4 files) [COMPLETED]
[x] Convert chapter-reader.js from IIFE to ES6 module
[x] Convert bible-filter.js from IIFE to ES6 module
[x] Convert theme-toggle.js from IIFE to ES6 module
[x] Convert theme-init.js from IIFE to ES6 module

### Batch 2: JavaScript Null/Undefined Safety (12 fixes) [COMPLETED]
[x] Add AbortController to chapter-reader.js loadAndRenderSSS() for race conditions
[x] Add null checks for form/clearBtn in offline-settings-ui.js
[x] Add CSS.escape() for querySelector in chapter-dropdown.js
[x] Add cleanup() function for SW message handler in offline-manager.js
[x] Add null checks throughout affected modules
[x] Improve error handling with proper error.message checks

### Batch 3: Hugo Template Nil Safety (4 fixes) [COMPLETED]
[x] Add $bibleData condition check in bible-nav.html
[x] Add nil check for $firstBible in book-chapter-selects.html
[x] Change to proper `{{ with }}` statement in bible-select.html
[x] Add nil check for $firstBible and $aux in compare.html

### Batch 4: CSS Dark Mode & Accessibility (10 fixes) [COMPLETED]
[x] Fix .sss-verse-num contrast ratio to 4.5:1 (var(--text-700))
[x] Fix .reader-toggles button contrast in dark mode
[x] Increase focus ring opacity from 0.35/0.45 to 0.6 in theme-colors.css
[x] Add hover states for .sss-verse-row
[x] Add SSS header focus styles
[x] Improve button contrast for dark mode pressed states

### Batch 5: Service Worker & PWA Fixes (5 fixes) [COMPLETED]
[x] Extend cache hash from 12 to 32 characters in sw.js
[x] Standardize AbortError checking to use error.name === 'AbortError'
[x] Fix chapter page regex to handle query params (?v=1)
[x] Separate metadata cache versioning from shell cache

### Batch 6: Template Accessibility (4 fixes) [COMPLETED]
[x] Add role="presentation" aria-hidden="true" to logo in header.html
[x] Add aria-label="Continue reading last chapter" in continue-reading.html
[x] Add required attribute to search input in search.html

### Batch 7: Code Quality & Configuration (6 fixes) [COMPLETED]
[x] Add serviceWorkerPath to config.js
[x] Add pwaInstallReshowDays to config.js
[x] Add toastAnimationMs to config.js
[x] Update chapter-reader.js to use config for basePath
[x] Update offline-manager.js to use config for SW path
[x] Update pwa-install.js to use config for reshow days
[x] Update dom-utils.js to use config for animation duration

================================================================================
COMPLETED SPRINT #1: ES6 Module Migration & Bug Fixes (2026-02-13)
================================================================================

### Batch 1: Critical Template Fixes [COMPLETED]
[x] Add id="main-content" to 9 layout files (skip-link target)
    - layouts/index.html
    - layouts/_default/list.html
    - layouts/_default/single.html
    - layouts/bible/list.html
    - layouts/bible/compare.html
    - layouts/bible/search.html
    - layouts/bible/single.html
    - layouts/license/list.html
    - layouts/license/single.html
[x] Fix undefined CSS variable (--shadow-2 â†’ --shadow-1)
[x] Fix external link security (add noreferrer to rel attribute)
[x] Add bible-data-map.html partial (O(1) Bible lookup)

### Batch 2: ES6 Foundation Modules [COMPLETED]
[x] Add dom-ready.js - DOM ready utility
[x] Add core.js - Module registry (Michael.register/get/init/cleanup)
[x] Add config.js - Centralized configuration
[x] Add listener-registry.js - Event listener cleanup tracking
[x] Add clipboard-utils.js - Clipboard copy with fallback
[x] Extract theme-init.js from baseof.html inline script
[x] Extract theme-toggle.js from baseof.html inline script
[x] Update baseof.html to use <script type="module">

### Batch 3: Core Module ES6 Conversion [COMPLETED]
[x] Convert dom-utils.js to ES6 module
[x] Convert bible-api.js to ES6 module
[x] Convert user-storage.js to ES6 module
[x] Convert verse-grid.js to ES6 module
[x] Convert chapter-dropdown.js to ES6 module

### Batch 4: Feature Module ES6 Conversion [COMPLETED]
[x] Convert bible-nav.js to ES6 module
[x] Convert bible-search.js to ES6 module + fix race condition
[x] Convert sss-mode.js to ES6 module + fix race condition
[x] Convert share-menu.js to ES6 module
[x] Convert share.js to ES6 module
[x] Convert footnotes.js to ES6 module + fix duplicate listeners

### Batch 5: Remaining Module Conversions [COMPLETED]
[x] Convert parallel.js to ES6 module
[x] Convert strongs.js to ES6 module
[x] Convert text-compare.js to ES6 module
[x] Convert diff-highlight.js to ES6 module
[x] Convert show-more.js to ES6 module
[x] Convert reading-tracker.js to ES6 module + fix scroll listener
[x] Convert pwa-install.js to ES6 module
[x] Convert offline-manager.js to ES6 module
[x] Convert offline-settings-ui.js to ES6 module

### Batch 6: Cleanup & Memory Fixes [COMPLETED]
[x] Add Michael.addCleanup() to all modules with event listeners
[x] Add null checks and validation throughout
[x] Handle QuotaExceededError in user-storage.js
[x] Add SW ready timeout in offline-manager.js
[x] Remove inline onclick handler from bible-nav.html

### Batch 7: CSS & Code Quality [COMPLETED]
[x] Remove duplicate light mode CSS block
[x] Remove obsolete clip property from sr-only
[x] Add dark mode focus states
[x] Remove all debug console.log statements

### Batch 8: Documentation & Final [COMPLETED]
[x] Update CHANGELOG.md with all changes
[ ] Run make test to verify
[ ] Commit and push

================================================================================
COMPLETED FEATURES
================================================================================

[x] Dark mode support (2026-02-13)
    - Theme toggle button in header
    - CSS variables for light/dark themes
    - localStorage persistence
    - Respects prefers-color-scheme

================================================================================
FUTURE FEATURES
================================================================================

[ ] Integrate _content.gotmpl with bible-data.html partial
    - Content adapter currently reads raw bibles.json for titles
    - Could use override titles in page generation for HTML <title> tags

[ ] Deprecate legacy <strong> verse format in bible-api.js
    - Strategy 2 (strong elements) and Strategy 5 (regex) can be removed
    - All content now uses modern .verse[data-verse] format

[ ] Review and clean up theme-colors.css defaults
    - Default values are now overridden by theme-custom.css

[ ] Performance optimization
    - Audit CSS bundle size after modularization
    - Consider lazy-loading non-critical CSS (print, compare, strongs)
    - Profile font loading impact

================================================================================
TESTING
================================================================================

[ ] Unit Tests for JavaScript Modules
    - Set up test framework (Jest or Vitest)
    - Test offline-manager.js, pwa-install.js, offline-settings-ui.js

[ ] Service Worker Tests
    - Test install, activate, and fetch strategy events
    - Test message handlers (CACHE_BIBLE, GET_CACHE_STATUS, etc.)

[ ] Integration Tests
    - Set up Playwright or Puppeteer
    - Test full download flow, offline navigation, cache clearing

[ ] PWA Audit Tests
    - Run Lighthouse PWA audit
    - Test install flow on Android, iOS, Desktop

[ ] Accessibility Tests
    - Keyboard navigation for all interactive elements
    - Screen reader compatibility
    - Focus management

[ ] Performance Tests
    - Cache operation performance
    - Memory usage during downloads
    - Startup time after install

================================================================================
DEPLOYMENT
================================================================================

[ ] Pre-deployment Verification
    - All Lighthouse PWA checks pass
    - Manifest validates without errors
    - Icons display correctly at all sizes
    - Install works on Android, iOS, Desktop
    - Offline mode works completely
    - No console errors in production build

[ ] Server Configuration
    - Verify HTTPS is enforced
    - Verify correct MIME types for manifest and SW
    - Add Cache-Control headers for static assets

================================================================================
