{{/* Canonical comparison table partial */}}
{{/* Shows which books are in which traditions with category indicators */}}

{{ $mappings := .Site.Data.book_mappings }}
{{ $traditions := $mappings.traditions }}
{{ $categories := $mappings.categories }}
{{ $sections := $mappings.sections }}
{{ $books := $mappings.books }}

{{/* Legend */}}
<section class="font-hand" style="margin-block-end: var(--pico-spacing);">
  <h3>Legend</h3>
  <div style="display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.875rem;">
    {{ range $id, $cat := $categories }}
    <span title="{{ $cat.description }}">{{ $cat.symbol }} {{ $cat.name }}</span>
    {{ end }}
  </div>
  <p style="margin-block-start: 0.5rem; color: var(--michael-gray); font-size: 0.875rem;">
    <span class="present">✓</span> = Present or historically received |
    <span class="absent">—</span> = Not included
  </p>
</section>

<figure style="overflow-x: auto;">
  <table class="canon-table">
    <thead>
      <tr>
        <th scope="col" style="text-align: left;">#</th>
        <th scope="col" style="text-align: left;">Book</th>
        <th scope="col" style="text-align: center;">Cat</th>
        {{ range $traditions }}
        <th scope="col" style="text-align: center; white-space: nowrap;" title="{{ .fullName }}: {{ .description }}">
          {{ .name }}
        </th>
        {{ end }}
        <th scope="col" style="text-align: left;">Notes</th>
      </tr>
    </thead>
    <tbody>
      {{ $currentSection := "" }}
      {{ range $books }}
      {{/* Section header */}}
      {{ if ne .section $currentSection }}
        {{ $currentSection = .section }}
        {{ $sectionData := dict }}
        {{ range $sections }}
          {{ if eq .id $currentSection }}
            {{ $sectionData = . }}
          {{ end }}
        {{ end }}
        <tr class="section-row">
          <td colspan="{{ add (len $traditions) 4 }}" scope="row">
            {{ $sectionData.name }}
          </td>
        </tr>
      {{ end }}
      {{/* Book row */}}
      <tr>
        <td style="font-size: 0.75rem;">{{ .seq }}</td>
        <td>
          {{ $basePath := $.Site.Params.michael.basePath | default "/religion/bibles" }}
          {{ if .drc_id }}
          <a href="{{ $basePath }}/drc/{{ .drc_id }}/">{{ .name }}</a>
          {{ else }}
          <strong>{{ .name }}</strong>
          {{ end }}
        </td>
        <td style="text-align: center;">
          {{/* Handle both single category and categories array */}}
          {{ if .categories }}
            {{ range $i, $catId := .categories }}{{ if $i }} {{ end }}{{ $cat := index $categories $catId }}<span title="{{ $cat.name }}: {{ $cat.description }}">{{ $cat.symbol }}</span>{{ end }}
          {{ else if .category }}
            {{ $cat := index $categories .category }}
            <span title="{{ $cat.name }}: {{ $cat.description }}">{{ $cat.symbol }}</span>
          {{ end }}
        </td>
        {{ $canonical := .canonical_in }}
        {{ range $traditions }}
        <td style="text-align: center;">
          {{ if in $canonical .id }}
          <span class="present" title="Present in {{ .fullName }}">✓</span>
          {{ else }}
          <span class="absent">—</span>
          {{ end }}
        </td>
        {{ end }}
        <td style="font-size: 0.75rem; color: var(--michael-gray);">
          {{ .notes }}
        </td>
      </tr>
      {{ end }}
    </tbody>
  </table>
</figure>

{{/* Book count summary table */}}
<section style="margin-block-start: calc(var(--pico-spacing) * 2);">
  <h3 class="font-hand">Canon Summary by Tradition</h3>
  <figure style="overflow-x: auto;">
    <table class="font-hand" style="font-size: 0.875rem;">
      <thead>
        <tr>
          <th scope="col" style="text-align: left;">Tradition</th>
          <th scope="col" style="text-align: center;">Books</th>
          <th scope="col" style="text-align: left;">Description</th>
        </tr>
      </thead>
      <tbody>
        {{ range $traditions }}
        {{/* Count books for this tradition */}}
        {{ $tradId := .id }}
        {{ $count := 0 }}
        {{ range $books }}
          {{ if in .canonical_in $tradId }}
            {{ $count = add $count 1 }}
          {{ end }}
        {{ end }}
        <tr>
          <td>
            <strong>{{ .name }}</strong>
            <span style="color: var(--michael-gray); margin-inline-start: 0.25rem;">({{ .fullName }})</span>
          </td>
          <td style="text-align: center;"><strong>{{ $count }}</strong></td>
          <td style="font-size: 0.75rem; color: var(--michael-gray);">{{ .description }}</td>
        </tr>
        {{ end }}
        <tr style="border-top: 2px solid var(--michael-border); background: color-mix(in srgb, var(--michael-light) 30%, transparent);">
          <td><strong>Total Unique Texts</strong></td>
          <td style="text-align: center;"><strong>{{ len $books }}</strong></td>
          <td style="font-size: 0.75rem; color: var(--michael-gray);">All texts across all traditions</td>
        </tr>
      </tbody>
    </table>
  </figure>
</section>

<footer class="font-hand" style="margin-block-start: 1rem; font-size: 0.75rem; color: var(--michael-gray);">
  <p><strong>Traditions:</strong>
    {{ range $i, $trad := $traditions }}{{ if $i }}, {{ end }}{{ $trad.name }} = {{ $trad.fullName }}{{ end }}
  </p>
</footer>
