{{/* Canonical comparison table partial */}}
{{/* Shows which books are in which traditions with category indicators */}}

{{ $mappings := .Site.Data.book_mappings }}
{{ $traditions := $mappings.traditions }}
{{ $categories := $mappings.categories }}
{{ $sections := $mappings.sections }}
{{ $books := $mappings.books }}

{{/* Legend */}}
<div class="canon-legend">
  <h3 class="canon-legend-title">Legend</h3>
  <div class="canon-legend-items">
    {{ range $id, $cat := $categories }}
    <span title="{{ $cat.description }}">{{ $cat.symbol }} {{ $cat.name }}</span>
    {{ end }}
  </div>
  <div class="canon-legend-hint">
    <span class="canon-present">&#10003;</span> = Present or historically received |
    <span class="canon-absent">&mdash;</span> = Not included
  </div>
</div>

<div class="canon-table-wrapper">
  <table class="canon-table">
    <thead>
      <tr class="canon-header-row">
        <th class="canon-th-seq">#</th>
        <th class="canon-th-book">Book</th>
        <th class="canon-th-cat">Cat</th>
        {{ range $traditions }}
        <th class="canon-th-tradition" title="{{ .fullName }}: {{ .description }}">
          {{ .name }}
        </th>
        {{ end }}
        <th class="canon-th-notes">Notes</th>
      </tr>
    </thead>
    <tbody>
      {{ $currentSection := "" }}
      {{ range $books }}
      {{/* Section header */}}
      {{ if ne .section $currentSection }}
        {{ $currentSection = .section }}
        {{ $sectionData := dict }}
        {{ range $sections }}
          {{ if eq .id $currentSection }}
            {{ $sectionData = . }}
          {{ end }}
        {{ end }}
        <tr class="canon-section-row">
          <td colspan="{{ add (len $traditions) 4 }}" class="canon-section-cell">
            {{ $sectionData.name }}
          </td>
        </tr>
      {{ end }}
      {{/* Book row */}}
      <tr class="canon-book-row">
        <td class="canon-td-seq">{{ .seq }}</td>
        <td class="canon-td-book">
          {{ $basePath := $.Site.Params.michael.basePath | default "/religion/bibles" }}
          {{ if .drc_id }}
          <a href="{{ $basePath }}/drc/{{ .drc_id }}/" class="canon-book-link">{{ .name }}</a>
          {{ else }}
          <span class="canon-book-name">{{ .name }}</span>
          {{ end }}
        </td>
        <td class="canon-td-cat">
          {{/* Handle both single category and categories array */}}
          {{ if .categories }}
            {{ range $i, $catId := .categories }}{{ if $i }} {{ end }}{{ $cat := index $categories $catId }}<span title="{{ $cat.name }}: {{ $cat.description }}">{{ $cat.symbol }}</span>{{ end }}
          {{ else if .category }}
            {{ $cat := index $categories .category }}
            <span title="{{ $cat.name }}: {{ $cat.description }}">{{ $cat.symbol }}</span>
          {{ end }}
        </td>
        {{ $canonical := .canonical_in }}
        {{ range $traditions }}
        <td class="canon-td-tradition">
          {{ if in $canonical .id }}
          <span class="canon-present" title="Present in {{ .fullName }}">&#10003;</span>
          {{ else }}
          <span class="canon-absent">&mdash;</span>
          {{ end }}
        </td>
        {{ end }}
        <td class="canon-td-notes">
          {{ .notes }}
        </td>
      </tr>
      {{ end }}
    </tbody>
  </table>
</div>

{{/* Book count summary table */}}
<div class="canon-summary">
  <h3 class="canon-summary-title">Canon Summary by Tradition</h3>
  <div class="canon-summary-table-wrapper">
    <table class="canon-summary-table">
      <thead>
        <tr class="canon-header-row">
          <th class="canon-th-tradition-name">Tradition</th>
          <th class="canon-th-count">Books</th>
          <th class="canon-th-desc">Description</th>
        </tr>
      </thead>
      <tbody>
        {{ range $traditions }}
        {{/* Count books for this tradition */}}
        {{ $tradId := .id }}
        {{ $count := 0 }}
        {{ range $books }}
          {{ if in .canonical_in $tradId }}
            {{ $count = add $count 1 }}
          {{ end }}
        {{ end }}
        <tr class="canon-book-row">
          <td class="canon-td-tradition-name">
            <span class="canon-tradition-name">{{ .name }}</span>
            <span class="canon-tradition-fullname">({{ .fullName }})</span>
          </td>
          <td class="canon-td-count">{{ $count }}</td>
          <td class="canon-td-desc">{{ .description }}</td>
        </tr>
        {{ end }}
        <tr class="canon-total-row">
          <td class="canon-td-total-label">Total Unique Texts</td>
          <td class="canon-td-total-count">{{ len $books }}</td>
          <td class="canon-td-total-desc">All texts across all traditions</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="canon-footer">
  <p class="canon-footer-text"><strong>Traditions:</strong>
    {{ range $i, $trad := $traditions }}{{ if $i }}, {{ end }}{{ $trad.name }} = {{ $trad.fullName }}{{ end }}
  </p>
</div>
