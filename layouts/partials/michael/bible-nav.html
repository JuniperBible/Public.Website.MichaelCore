{{/* Bible navigation component with dropdowns */}}
{{/* Usage: {{ partial "michael/bible-nav.html" (dict "page" . "bible" .Params.bible "book" .Params.book "chapter" .Params.chapter "basePath" $basePath) }} */}}

{{ $page := .page }}
{{ $bible := .bible }}
{{ $book := .book }}
{{ $chapter := .chapter }}
{{ $basePath := .basePath | default "/religion/bibles" }}

{{ $bibleData := index $page.Site.Data.bibles_auxiliary $bible }}

{{/* Get valid books from page params if available, otherwise use all books from data */}}
{{ $validBooks := $page.Params.validBooks }}

{{/* Find current book data once (used by chapter selector and navigation) */}}
{{ $bookData := dict }}
{{ $chapterCount := 0 }}
{{ if and $book $chapter }}
  {{ range $bibleData.books }}
    {{ if eq (.id | lower) $book }}
      {{ $bookData = . }}
    {{ end }}
  {{ end }}
  {{ $chapterCount = len $bookData.chapters }}
{{ end }}

<nav class="reader-bar row" aria-label="{{ i18n "bibleNavigation" | default "Bible Navigation" }}" style="margin-bottom: var(--pad-2);">
  <!-- Bible selector (always shown when bible is set) -->
  {{ with $bible }}
  <select id="bible-select"
          class="select"
          style="width: auto;"
          onchange="if(this.value) window.location.href=this.value">
    {{ range $page.Site.Data.bibles.bibles }}
      {{/* Only show bibles that have auxiliary data */}}
      {{ $hasAuxData := index $page.Site.Data.bibles_auxiliary .id }}
      {{ if $hasAuxData }}
    <option value="{{ printf "%s/%s/" $basePath .id | relLangURL }}" {{ if eq .id $bible }}selected{{ end }}>
      {{ .abbrev }}
    </option>
      {{ end }}
    {{ end }}
  </select>
  {{ end }}

  <!-- Book selector (always shown - uses validBooks if available) -->
  {{ if $bible }}
  <select id="book-select"
          class="select"
          style="width: auto;"
          onchange="if(this.value) window.location.href=this.value">
    {{/* Show placeholder when no book selected */}}
    {{ if not $book }}
    <option value="" selected disabled>{{ i18n "selectBook" | default "Select Book" }}</option>
    {{ end }}
    {{/* Use validBooks if available (from Bible overview page), otherwise use all books */}}
    {{ if $validBooks }}
      {{ range $validBooks }}
      <option value="{{ printf "%s/%s/%s/" $basePath $bible .id | relLangURL }}" {{ if eq .id $book }}selected{{ end }}>
        {{ .name }}
      </option>
      {{ end }}
    {{ else }}
      {{/* Show all books from auxiliary data */}}
      {{ range $bibleData.books }}
        {{ $bookIdLower := .id | lower }}
        <option value="{{ printf "%s/%s/%s/" $basePath $bible $bookIdLower | relLangURL }}" {{ if eq $bookIdLower $book }}selected{{ end }}>
          {{ .name }}
        </option>
      {{ end }}
    {{ end }}
  </select>
  {{ end }}

  <!-- Chapter selector (if viewing a chapter) -->
  {{ with $chapter }}
  <select id="chapter-select"
          class="select"
          style="width: auto;"
          onchange="if(this.value) window.location.href=this.value">
    {{ range $i := seq $chapterCount }}
    <option value="{{ printf "%s/%s/%s/%d/" $basePath $bible $book $i | relLangURL }}" {{ if eq $i $chapter }}selected{{ end }}>
      {{ i18n "chapter" | default "Ch" }} {{ $i }}
    </option>
    {{ end }}
  </select>

  <!-- Prev/Next Navigation -->
  {{ if gt $chapter 1 }}
  <a href="{{ printf "%s/%s/%s/%d/" $basePath $bible $book (sub $chapter 1) | relLangURL }}"
     class="btn btn--sm"
     title="{{ i18n "previousChapter" | default "Previous Chapter" }}">
    ←
  </a>
  {{ else }}
  <span class="btn btn--sm is-disabled" aria-disabled="true">←</span>
  {{ end }}

  {{ if lt $chapter $chapterCount }}
  <a href="{{ printf "%s/%s/%s/%d/" $basePath $bible $book (add $chapter 1) | relLangURL }}"
     class="btn btn--sm"
     title="{{ i18n "nextChapter" | default "Next Chapter" }}">
    →
  </a>
  {{ else }}
  <span class="btn btn--sm is-disabled" aria-disabled="true">→</span>
  {{ end }}
  {{ end }}
</nav>
