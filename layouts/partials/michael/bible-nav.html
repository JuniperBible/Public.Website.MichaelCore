{{/*
  Partial: bible-nav.html
  Purpose: Bible navigation component with book/chapter dropdowns and prev/next links

  Description:
    This partial provides a complete navigation interface for browsing Bible translations,
    books, and chapters. It renders dropdown selectors for Bible translation and book
    selection, as well as chapter navigation with previous/next buttons. The component
    adapts based on the current context (Bible overview, book list, or chapter view).

  Parameters (via dict):
    - page: Current page context (required) - provides access to site data and params
    - bible: Bible ID string (required) - identifies which translation to display (e.g., "kjv", "web")
    - book: Current book ID (optional) - lowercase book identifier (e.g., "gen", "matt")
    - chapter: Current chapter number (optional) - integer chapter number
    - basePath: Base URL path for Bible content (optional, defaults to "/bible")

  Data Sources:
    - .Site.Data.bibles.bibles: Bible metadata including ID, abbreviation, and display name
    - .Site.Data.bibles_auxiliary: Book/chapter structure for each Bible translation
    - .Params.validBooks: Optional page param to restrict visible books (used on overview pages)

  Usage Examples:

    # On a Bible overview page (shows Bible selector and book dropdown):
    {{ partial "michael/bible-nav.html" (dict "page" . "bible" .Params.bible) }}

    # On a book overview page (adds book context):
    {{ partial "michael/bible-nav.html" (dict "page" . "bible" .Params.bible "book" .Params.book) }}

    # On a chapter page (full navigation with chapter selector and prev/next):
    {{ partial "michael/bible-nav.html" (dict "page" . "bible" .Params.bible "book" .Params.book "chapter" .Params.chapter) }}

    # With custom base path:
    {{ partial "michael/bible-nav.html" (dict "page" . "bible" .Params.bible "book" .Params.book "chapter" .Params.chapter "basePath" "/custom/path") }}

  Features:
    - Bible translation selector: Dropdown of all available Bible translations with auxiliary data
    - Book dropdown: Lists all available books (respects validBooks param if provided)
    - Chapter selector: Dynamically populated based on selected book's chapter count
    - Previous/Next navigation: Arrow buttons for sequential chapter navigation
    - Accessible: Includes ARIA labels and proper semantic HTML
    - i18n support: Uses internationalization keys for labels
    - Handles versification differences: Chapter counts vary between translations
    - Responsive: Adapts display based on available context (Bible/book/chapter)

  Notes:
    - Only Bibles with auxiliary data (book/chapter structure) are shown in the selector
    - Book IDs are normalized to lowercase for consistency
    - Navigation buttons are disabled (not hidden) at boundaries for better UX
    - URLs are generated using relLangURL for multi-language support
    - The component uses the .reader-bar and .select CSS classes for styling
*/}}

{{ $page := .page }}
{{ $bible := .bible }}
{{ $book := .book }}
{{ $chapter := .chapter }}
{{ $basePath := .basePath | default "/bible" }}

{{ $bibleData := index $page.Site.Data.bibles_auxiliary $bible }}

{{/* Get valid books from page params if available, otherwise use all books from data */}}
{{ $validBooks := $page.Params.validBooks }}

{{/* Find current book data once (used by chapter selector and navigation) */}}
{{ $bookData := dict }}
{{ $chapterCount := 0 }}
{{ if and $book $chapter }}
  {{ range $bibleData.books }}
    {{ if eq (.id | lower) $book }}
      {{ $bookData = . }}
    {{ end }}
  {{ end }}
  {{ $chapterCount = len $bookData.chapters }}
{{ end }}

<nav class="reader-bar row bible-nav" aria-label="{{ i18n "bibleNavigation" | default "Bible Navigation" }}">
  <!-- Bible selector (always shown when bible is set) -->
  {{/* Preserve book/chapter context when switching translations */}}
  {{ with $bible }}
  <label for="bible-select" class="sr-only">{{ i18n "selectBibleTranslation" | default "Select Bible Translation" }}</label>
  <select id="bible-select"
          class="select bible-nav__select"
          data-base-path="{{ $basePath }}"
          {{ with $book }}data-book="{{ . }}"{{ end }}
          {{ with $chapter }}data-chapter="{{ . }}"{{ end }}
          aria-label="{{ i18n "selectBibleTranslation" | default "Select Bible Translation" }}">
    {{ range (partialCached "michael/bible-data.html" $page.Site) }}
      {{/* Only show bibles that have auxiliary data */}}
      {{ $hasAuxData := index $page.Site.Data.bibles_auxiliary .id }}
      {{ if $hasAuxData }}
    <option value="{{ .id }}" {{ if eq .id $bible }}selected{{ end }}>
      {{ .abbrev }}
    </option>
      {{ end }}
    {{ end }}
  </select>
  {{ end }}

  <!-- Book selector (always shown - uses validBooks if available) -->
  {{ if $bible }}
  <label for="book-select" class="sr-only">{{ i18n "selectBook" | default "Select Book" }}</label>
  <select id="book-select"
          class="select bible-nav__select"
          aria-label="{{ i18n "selectBook" | default "Select Book" }}">
    {{/* Show placeholder when no book selected */}}
    {{ if not $book }}
    <option value="" selected disabled>{{ i18n "selectBook" | default "Select Book" }}</option>
    {{ end }}
    {{/* Use validBooks if available (from Bible overview page), otherwise use all books */}}
    {{ if $validBooks }}
      {{ range $validBooks }}
      <option value="{{ printf "%s/%s/%s/" $basePath $bible .id | relLangURL }}" {{ if eq .id $book }}selected{{ end }}>
        {{ .name }}
      </option>
      {{ end }}
    {{ else }}
      {{/* Show all books from auxiliary data */}}
      {{ range $bibleData.books }}
        {{ $bookIdLower := .id | lower }}
        <option value="{{ printf "%s/%s/%s/" $basePath $bible $bookIdLower | relLangURL }}" {{ if eq $bookIdLower $book }}selected{{ end }}>
          {{ .name }}
        </option>
      {{ end }}
    {{ end }}
  </select>
  {{ end }}

  <!-- Chapter selector (if viewing a chapter) -->
  {{ with $chapter }}
  <label for="chapter-select" class="sr-only">{{ i18n "selectChapter" | default "Select Chapter" }}</label>
  <select id="chapter-select"
          class="select bible-nav__select"
          aria-label="{{ i18n "selectChapter" | default "Select Chapter" }}">
    {{ range $i := seq $chapterCount }}
    <option value="{{ printf "%s/%s/%s/%d/" $basePath $bible $book $i | relLangURL }}" {{ if eq $i $chapter }}selected{{ end }}>
      {{ i18n "chapter" | default "Ch" }} {{ $i }}
    </option>
    {{ end }}
  </select>

  <!-- Prev/Next Navigation -->
  {{ if gt $chapter 1 }}
  <a href="{{ printf "%s/%s/%s/%d/" $basePath $bible $book (sub $chapter 1) | relLangURL }}"
     class="btn btn--sm"
     aria-label="{{ i18n "previousChapter" | default "Previous Chapter" }}"
     title="{{ i18n "previousChapter" | default "Previous Chapter" }}">
    ←
  </a>
  {{ else }}
  <button type="button" class="btn btn--sm" disabled aria-label="{{ i18n "previousChapter" | default "Previous Chapter" }} {{ i18n "disabled" | default "(disabled)" }}">&larr;</button>
  {{ end }}

  {{ if lt $chapter $chapterCount }}
  <a href="{{ printf "%s/%s/%s/%d/" $basePath $bible $book (add $chapter 1) | relLangURL }}"
     class="btn btn--sm"
     aria-label="{{ i18n "nextChapter" | default "Next Chapter" }}"
     title="{{ i18n "nextChapter" | default "Next Chapter" }}">
    →
  </a>
  {{ else }}
  <button type="button" class="btn btn--sm" disabled aria-label="{{ i18n "nextChapter" | default "Next Chapter" }} {{ i18n "disabled" | default "(disabled)" }}">&rarr;</button>
  {{ end }}

  <!-- Reader toggles (chapter view only) -->
  <span class="reader-toggles">
    <button type="button" id="fullwidth-toggle" class="btn btn--sm" aria-pressed="false" aria-label="{{ i18n "toggleFullWidth" | default "Toggle Full Width" }}" title="{{ i18n "fullWidth" | default "Full Width" }}">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
      </svg>
    </button>
    <button type="button" id="sss-chapter-toggle" class="btn btn--sm" aria-pressed="false" aria-label="{{ i18n "toggleSSS" | default "Toggle Side-by-Side Scripture" }}" title="{{ i18n "sideBySide" | default "Side-by-Side" }}">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <rect x="3" y="3" width="7" height="18" rx="1" stroke-width="2"/>
        <rect x="14" y="3" width="7" height="18" rx="1" stroke-width="2"/>
      </svg>
    </button>
    <button type="button" id="print-chapter" class="btn btn--sm" aria-label="{{ i18n "printChapter" | default "Print Chapter" }}" title="{{ i18n "print" | default "Print" }}" onclick="window.print()">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
      </svg>
    </button>
    <button type="button" id="share-chapter" class="btn btn--sm" aria-label="{{ i18n "shareChapter" | default "Share Chapter" }}" title="{{ i18n "share" | default "Share" }}">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
      </svg>
    </button>
  </span>

  <!-- SSS Comparison Bible selector (hidden until SSS mode active) -->
  <select id="sss-comparison-bible" class="select bible-nav__select sss-comparison-select" aria-label="{{ i18n "selectComparisonBible" | default "Select Comparison Bible" }}">
    <option value="">{{ i18n "selectBible" | default "Select Bible..." }}</option>
    {{ range (partialCached "michael/bible-data.html" $page.Site) }}
      {{ $hasAuxData := index $page.Site.Data.bibles_auxiliary .id }}
      {{ if and $hasAuxData (ne .id $bible) }}
    <option value="{{ .id }}">{{ .abbrev }}</option>
      {{ end }}
    {{ end }}
  </select>
  {{ end }}
</nav>
