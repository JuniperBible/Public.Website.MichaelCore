{{/*
  Template: single.html
  Purpose: Bible chapter display page

  Features:
  - Chapter text with verse numbers
  - Strong's number tooltips (for translations with Strong's data)
  - Verse sharing buttons
  - Previous/Next chapter navigation
  - Book/Chapter navigation dropdown

  Data Sources:
  - .Params: Page front matter (bible, book, chapter)
  - .Site.Data.bibles.bibles: Bible metadata
  - .Site.Data.bibles_auxiliary: Book/chapter structure
  - .Content: Rendered verse content

  JavaScript Dependencies:
  - strongs.js: Strong's number tooltips
  - share.js: Verse sharing
  - michael/share-menu.js: Share menu component

  URL Parameters:
  - v: Verse number (scroll to and highlight)
*/}}

{{ define "scripts" }}
{{/* Inject Strong's definitions data (cached â€” identical across all pages) */}}
{{ partialCached "michael/strongs-data.html" . }}
{{/* Load JS with fingerprinting for cache busting */}}
{{ $bibleNav := resources.Get "js/michael/bible-nav.js" }}
{{ if $bibleNav }}{{ $bibleNav = $bibleNav | fingerprint }}<script src="{{ $bibleNav.RelPermalink }}" defer></script>{{ end }}
{{ $shareMenu := resources.Get "js/michael/share-menu.js" }}
{{ if $shareMenu }}{{ $shareMenu = $shareMenu | fingerprint }}<script src="{{ $shareMenu.RelPermalink }}" defer></script>{{ end }}
{{ $share := resources.Get "js/share.js" }}
{{ if $share }}{{ $share = $share | fingerprint }}<script src="{{ $share.RelPermalink }}" defer></script>{{ end }}
{{ $strongs := resources.Get "js/strongs.js" }}
{{ if $strongs }}{{ $strongs = $strongs | fingerprint }}<script src="{{ $strongs.RelPermalink }}" defer></script>{{ end }}
{{ $footnotes := resources.Get "js/michael/footnotes.js" }}
<<<<<<< HEAD
{{ if $footnotes }}{{ $footnotes = $footnotes | fingerprint }}<script src="{{ $footnotes.RelPermalink }}" defer></script>{{ end }}
{{ $chapterReader := resources.Get "js/michael/chapter-reader.js" }}
{{ if $chapterReader }}{{ $chapterReader = $chapterReader | fingerprint }}<script src="{{ $chapterReader.RelPermalink }}" defer></script>{{ end }}
=======
{{ if $footnotes }}<script src="{{ $footnotes.RelPermalink }}" defer></script>{{ end }}
{{ $chapterReader := resources.Get "js/michael/chapter-reader.js" }}
{{ if $chapterReader }}<script src="{{ $chapterReader.RelPermalink }}" defer></script>{{ end }}
>>>>>>> 8d2bc0a (Add full-width and side-by-side scripture toggles to chapter pages)
{{ end }}

{{ define "main" }}
{{ $basePath := .Site.Params.michael.basePath | default "/bible" }}
<main class="container pad-3-2">
  <article class="panel">
    {{/* Look up Bible metadata from bibles-data partial (includes overrides) */}}
    {{ $bibleId := .Params.bible | default .Params.abbrev | default .File.ContentBaseName }}
    {{ $bibleData := dict }}
    {{ range (partialCached "michael/bible-data.html" .Site) }}
      {{ if eq .id $bibleId }}
        {{ $bibleData = . }}
      {{ end }}
    {{ end }}

    <header class="page-header">
      {{/* On Bible overview pages, prefer override title and description */}}
      {{ if not (or .Params.chapter .Params.book) }}
        <h1>{{ with $bibleData.title }}{{ . }}{{ else }}{{ .Title }}{{ end }}</h1>
        {{ with $bibleData.description }}<p>{{ . }}</p>{{ end }}
      {{ else }}
        <h1>{{ .Title }}</h1>
        {{ with .Params.description }}<p>{{ . }}</p>{{ end }}
      {{ end }}

      <!-- Features/tags -->
      <div class="row row--center mt-1">
        {{ with $bibleData.language }}
        <span class="badge">{{ . }}</span>
        {{ end }}
        {{ with $bibleData.license }}
        <a href="{{ printf "/license/%s/" (. | lower) | relLangURL }}" class="badge" title="SPDX License: {{ . }}">{{ . }}</a>
        {{ end }}
        {{/* Fallback to params if not in bibles.json */}}
        {{ if not .Site.Data.bibles.bibles }}
          {{ with .Params.language }}
          <span class="badge">{{ . }}</span>
          {{ end }}
        {{ end }}
        {{ range .Params.features }}
        <span class="badge">{{ . }}</span>
        {{ end }}
      </div>
    </header>

    <!-- Bible chapter content or book navigation -->
    {{ if .Params.chapter }}
      <!-- Chapter view: show verses -->
      <section>
        <!-- Navigation with dropdowns -->
        {{ partial "michael/bible-nav.html" (dict "page" . "bible" .Params.bible "book" .Params.book "chapter" .Params.chapter "basePath" $basePath) }}

        <!-- Single column view (default) -->
        <div class="chapter-content-single">
          <div class="prose bible-text" id="chapter-content">
            {{ .Content }}
          </div>
        </div>

        <!-- Side-by-side view (shown when SSS toggle active) -->
        <div class="chapter-sss-container">
          <div class="chapter-sss-pane" id="sss-left-pane">
            <div class="pane-header">
              <strong>{{ $bibleData.abbrev }}</strong>
            </div>
            <div class="pane-content prose bible-text">
              {{ .Content }}
            </div>
          </div>
          <div class="chapter-sss-pane" id="sss-right-pane">
            <div class="pane-header">
              <select id="sss-comparison-bible" class="select" aria-label="{{ i18n "selectComparisonBible" | default "Select Comparison Bible" }}">
                <option value="">{{ i18n "selectBible" | default "Select Bible..." }}</option>
                {{ range (partialCached "michael/bible-data.html" .Site) }}
                  {{ $hasAuxData := index $.Site.Data.bibles_auxiliary .id }}
                  {{ if and $hasAuxData (ne .id $.Params.bible) }}
                <option value="{{ .id }}">{{ .abbrev }}</option>
                  {{ end }}
                {{ end }}
              </select>
            </div>
            <div class="pane-content">
              <div class="loading">{{ i18n "selectBibleToCompare" | default "Select a Bible to compare" }}</div>
            </div>
          </div>
        </div>

        <!-- Notes sections (side by side) -->
        <div class="chapter-notes-row" id="chapter-notes-row">
          {{ partial "michael/notes-section.html" (dict "type" "both") }}
        </div>

        <!-- Bottom navigation for convenience -->
        {{ partial "michael/bible-nav.html" (dict "page" . "bible" .Params.bible "book" .Params.book "chapter" .Params.chapter "basePath" $basePath) }}
      </section>

    {{ else if .Params.book }}
      <!-- Book view: show chapter list -->
      {{ partial "michael/bible-nav.html" (dict "page" . "bible" .Params.bible "book" .Params.book "chapter" 0 "basePath" $basePath) }}
      <div class="book-content">
        {{ .Content }}
      </div>

    {{ else }}
      <!-- Bible overview: show book list -->
      {{ partial "michael/bible-nav.html" (dict "page" . "bible" .Params.bible "book" "" "chapter" 0 "basePath" $basePath) }}
      <div class="book-content">
        {{ .Content }}
      </div>
    {{ end }}

    <!-- Navigation -->
    <nav class="actions">
      {{ if .Params.chapter }}
        <a href="{{ printf "%s/%s/%s/" $basePath .Params.bible .Params.book | relLangURL }}" class="btn">
          &larr; {{ i18n "backToBook" | default "Back to Book" }}
        </a>
        <a href="{{ printf "%s/compare/?bibles=%s&ref=%s.%d" $basePath .Params.bible .Params.book .Params.chapter | relLangURL }}" class="btn btn--secondary">
          {{ i18n "compareTranslations" | default "Compare Translations" }}
        </a>
      {{ else if .Params.book }}
        <a href="{{ printf "%s/%s/" $basePath .Params.bible | relLangURL }}" class="btn">
          &larr; {{ i18n "backToBible" | default "Back to Bible" }}
        </a>
      {{ else }}
        <a href="{{ printf "%s/" $basePath | relLangURL }}" class="btn">
          &larr; {{ i18n "allBibles" | default "All Bibles" }}
        </a>
        <a href="{{ printf "%s/compare/?bibles=%s" $basePath .Params.bible | relLangURL }}" class="btn btn--secondary">
          {{ i18n "compareTranslations" | default "Compare Translations" }}
        </a>
      {{ end }}
    </nav>
  </article>
</main>
{{ end }}
