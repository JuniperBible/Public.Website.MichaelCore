{{ define "scripts" }}
{{ $textCompare := resources.Get "js/text-compare.js" }}
{{ if $textCompare }}
<script src="{{ $textCompare.RelPermalink }}" defer></script>
{{ end }}
{{ $parallel := resources.Get "js/parallel.js" }}
{{ if $parallel }}
<script src="{{ $parallel.RelPermalink }}" defer></script>
{{ end }}
{{ end }}

{{ define "main" }}
{{ $basePath := .Site.Params.michael.basePath | default "/religion/bibles" }}
<main class="container" style="padding: var(--pad-3) var(--pad-2);">
  <div class="panel">
    <header class="page-header">
      <h1>{{ .Title }}</h1>
      <p>{{ .Description }}</p>
    </header>

    <!-- Unified Selector Panel (Normal Mode) -->
    <div id="normal-mode" class="panel--inner" style="padding: var(--pad-2);">
      <!-- All controls in one row -->
      <div class="row" style="flex-wrap: wrap; gap: var(--pad-1);">
        <!-- Translations -->
        <div class="row" id="translation-checkboxes" style="gap: 8px;">
          {{ range .Site.Data.bibles.bibles }}
          <label class="chip" style="cursor: pointer;">
            <input type="checkbox"
                   class="translation-checkbox"
                   value="{{ .id }}"
                   data-abbrev="{{ .abbrev }}"
                   data-title="{{ .title }}"
                   style="margin-right: 4px;">
            <span>{{ .abbrev }}</span>
          </label>
          {{ end }}
        </div>
        <span class="muted">|</span>
        <!-- Passage selectors -->
        <select id="book-select" class="select" style="width: auto;">
          <option value="">Book...</option>
          {{ $firstBible := index .Site.Data.bibles.bibles 0 }}
          {{ $aux := index .Site.Data.bibles_auxiliary $firstBible.id }}
          {{ range $aux.books }}
          <option value="{{ .id }}">{{ .name }}</option>
          {{ end }}
        </select>
        <select id="chapter-select" class="select" style="width: auto;" disabled>
          <option value="">Ch...</option>
        </select>
        <!-- Compare Differences with toggle and color picker -->
        <label class="chip" style="cursor: pointer;">
          <input type="checkbox" id="highlight-toggle" style="margin-right: 4px;">
          <span>Compare Differences</span>
        </label>
        <button id="highlight-color-btn" class="btn btn--sm" style="background-color: #666; width: 24px; height: 24px; padding: 0;" title="Choose highlight color"></button>
        <div id="highlight-color-picker" class="hidden" style="position: absolute; background: var(--surface-1); border: 1px solid var(--border); border-radius: var(--radius-1); padding: 8px; z-index: 10;">
          <div class="row" style="gap: 4px;">
            <button class="color-option btn btn--sm" data-color="#222" style="background:#222; width:24px; height:24px; padding:0;" title="Dark"></button>
            <button class="color-option btn btn--sm" data-color="#444" style="background:#444; width:24px; height:24px; padding:0;" title="Medium Dark"></button>
            <button class="color-option btn btn--sm" data-color="#666" style="background:#666; width:24px; height:24px; padding:0;" title="Medium"></button>
            <button class="color-option btn btn--sm" data-color="#888" style="background:#888; width:24px; height:24px; padding:0;" title="Medium Light"></button>
            <button class="color-option btn btn--sm" data-color="#aaa" style="background:#aaa; width:24px; height:24px; padding:0;" title="Light"></button>
          </div>
        </div>
        <!-- SSS Mode toggle -->
        <button id="sss-mode-btn" class="btn btn--secondary">
          <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <polygon points="12,2 22,20 2,20" stroke-width="2" stroke-linejoin="round"/>
            <circle cx="12" cy="14" r="5" stroke-width="2"/>
            <circle cx="12" cy="14" r="1.5" fill="currentColor" stroke="none"/>
          </svg>
          <span>SSS <span id="sss-mode-status">OFF</span></span>
        </button>
      </div>
      <!-- Verse grid (shown when chapter is selected) -->
      <div id="verse-grid" class="hidden mt-2">
        <div class="row" style="align-items: center; gap: 8px;">
          <span class="muted">v:</span>
          <button id="all-verses-btn" class="chip is-active">All</button>
          <div class="row" id="verse-buttons" style="gap: 4px;"></div>
        </div>
      </div>
    </div>

    <!-- SSS Mode (Side by Side Scripture) - Hidden by default -->
    <div id="sss-mode" class="hidden">
      <!-- SSS Controls -->
      <div class="panel--inner mt-2" style="padding: var(--pad-2);">
        <div class="row" style="flex-wrap: wrap; gap: var(--pad-1);">
          <button id="sss-back-btn" class="btn btn--sm" title="Back to Compare">&larr;</button>
          <select id="sss-bible-left" class="select" style="width: auto;">
            <option value="">Left Bible...</option>
            {{ range .Site.Data.bibles.bibles }}
            <option value="{{ .id }}">{{ .title }} ({{ .abbrev }})</option>
            {{ end }}
          </select>
          <select id="sss-bible-right" class="select" style="width: auto;">
            <option value="">Right Bible...</option>
            {{ range .Site.Data.bibles.bibles }}
            <option value="{{ .id }}">{{ .title }} ({{ .abbrev }})</option>
            {{ end }}
          </select>
          <span class="muted">|</span>
          <select id="sss-book-select" class="select" style="width: auto;">
            <option value="">Book...</option>
            {{ $firstBible := index .Site.Data.bibles.bibles 0 }}
            {{ $aux := index .Site.Data.bibles_auxiliary $firstBible.id }}
            {{ range $aux.books }}
            <option value="{{ .id }}">{{ .name }}</option>
            {{ end }}
          </select>
          <select id="sss-chapter-select" class="select" style="width: auto;" disabled>
            <option value="">Ch...</option>
          </select>
          <!-- Compare Differences with toggle and color picker (SSS mode) -->
          <label class="chip" style="cursor: pointer;">
            <input type="checkbox" id="sss-highlight-toggle" checked style="margin-right: 4px;">
            <span>Compare Differences</span>
          </label>
          <button id="sss-highlight-color-btn" class="btn btn--sm" style="background-color: #666; width: 24px; height: 24px; padding: 0;" title="Choose highlight color"></button>
          <div id="sss-highlight-color-picker" class="hidden" style="position: absolute; background: var(--surface-1); border: 1px solid var(--border); border-radius: var(--radius-1); padding: 8px; z-index: 10;">
            <div class="row" style="gap: 4px;">
              <button class="sss-color-option btn btn--sm" data-color="#222" style="background:#222; width:24px; height:24px; padding:0;" title="Dark"></button>
              <button class="sss-color-option btn btn--sm" data-color="#444" style="background:#444; width:24px; height:24px; padding:0;" title="Medium Dark"></button>
              <button class="sss-color-option btn btn--sm" data-color="#666" style="background:#666; width:24px; height:24px; padding:0;" title="Medium"></button>
              <button class="sss-color-option btn btn--sm" data-color="#888" style="background:#888; width:24px; height:24px; padding:0;" title="Medium Light"></button>
              <button class="sss-color-option btn btn--sm" data-color="#aaa" style="background:#aaa; width:24px; height:24px; padding:0;" title="Light"></button>
            </div>
          </div>
          <button id="sss-toggle-btn" class="btn btn--secondary">
            <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <polygon points="12,2 22,20 2,20" stroke-width="2" stroke-linejoin="round"/>
              <circle cx="12" cy="14" r="5" stroke-width="2"/>
              <circle cx="12" cy="14" r="1.5" fill="currentColor" stroke="none"/>
            </svg>
            <span>SSS <span id="sss-status">ON</span></span>
          </button>
        </div>
        <!-- SSS Verse grid (shown when chapter is selected) -->
        <div id="sss-verse-grid" class="hidden mt-2">
          <div class="row" style="align-items: center; gap: 8px;">
            <span class="muted">v:</span>
            <button id="sss-all-verses-btn" class="chip is-active">All</button>
            <div class="row" id="sss-verse-buttons" style="gap: 4px;"></div>
          </div>
        </div>
      </div>

      <!-- Side by Side Panes -->
      <div class="grid-2 mt-2" id="sss-panes">
        <div class="card" id="sss-left-pane">
          <div class="center muted">Select a Bible</div>
        </div>
        <div class="card" id="sss-right-pane">
          <div class="center muted">Select a Bible</div>
        </div>
      </div>
    </div>

    <!-- Parallel Verse Display (Normal Mode) -->
    <div id="parallel-content" class="mt-3">
      <div class="center muted">
        {{ i18n "selectPassagePrompt" | default "Select 2+ translations and a passage to compare." }}
      </div>
    </div>

    <!-- Back Navigation -->
    <nav class="actions">
      <a href="{{ printf "%s/" $basePath | relLangURL }}" class="btn">
        &larr; {{ i18n "allBibles" | default "All Bibles" }}
      </a>
    </nav>
  </div>
</main>

<!-- Bible Data for JavaScript - book structure only, verses loaded on-demand -->
<script id="bible-data" type="application/json">
{{ $biblesMeta := slice }}
{{ range .Site.Data.bibles.bibles }}
  {{ $biblesMeta = $biblesMeta | append (dict "id" .id "title" .title "abbrev" .abbrev "description" .description "language" .language) }}
{{ end }}
{{ $firstBible := index .Site.Data.bibles.bibles 0 }}
{{ $aux := index .Site.Data.bibles_auxiliary $firstBible.id }}
{{ $booksList := slice }}
{{ range $aux.books }}
  {{ $booksList = $booksList | append (dict "id" .id "name" .name "chapters" (len .chapters)) }}
{{ end }}
{{ dict "bibles" $biblesMeta "books" $booksList "basePath" ($basePath | relLangURL) | jsonify | safeJS }}
</script>
{{ end }}
