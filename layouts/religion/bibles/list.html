{{ define "main" }}
<main class="container" style="padding: var(--pad-3) var(--pad-2);">
  <div class="panel">
    <header class="page-header">
      <h1>{{ i18n "bibles" | default "Bibles" }}</h1>
      <p>{{ i18n "biblesDescription" | default "Browse available Bible translations" }}</p>

      <!-- Quick actions -->
      <nav class="actions">
        {{ $basePath := .Site.Params.michael.basePath | default "/religion/bibles" }}
        <a href="{{ printf "%s/search/" $basePath | relLangURL }}" class="btn btn--primary">
          {{ i18n "searchBible" | default "Search Bible" }}
        </a>
        <a href="{{ printf "%s/compare/" $basePath | relLangURL }}" class="btn btn--secondary">
          {{ i18n "compareTranslations" | default "Compare Translations" }}
        </a>
      </nav>

      <!-- Filter by tag -->
      {{/* Build unique tags from all bibles */}}
      {{ $allTags := slice }}
      {{ range .Site.Data.bibles.bibles }}
        {{ range .tags }}
          {{ $allTags = $allTags | append . }}
        {{ end }}
      {{ end }}
      {{ $uniqueTags := $allTags | uniq | sort }}

      <div class="row mt-2" id="bible-filters" role="group" aria-label="{{ i18n "filterByTag" | default "Filter by Tag" }}" style="justify-content: center;">
        <button
          type="button"
          class="chip is-active"
          data-tag="all"
          aria-pressed="true">
          {{ i18n "all" | default "All" }}
        </button>
        {{ range $uniqueTags }}
        <button
          type="button"
          class="chip"
          data-tag="{{ . | urlize }}"
          aria-pressed="false">
          {{ . }}
        </button>
        {{ end }}
      </div>
    </header>

    <!-- Quick navigation -->
    {{ $basePath := .Site.Params.michael.basePath | default "/religion/bibles" }}
    <div class="row mt-2" style="justify-content: center;">
      <label class="sr-only" for="bible-select">{{ i18n "selectBible" | default "Select Bible" }}</label>
      <select id="bible-select"
              class="select"
              style="width: auto;"
              onchange="if(this.value) window.location.href=this.value">
        <option value="" selected disabled>{{ i18n "selectBible" | default "Select Bible" }}</option>
        {{ range .Site.Data.bibles.bibles }}
          {{/* Only show bibles that have auxiliary data */}}
          {{ $hasAuxData := index $.Site.Data.bibles_auxiliary .id }}
          {{ if $hasAuxData }}
        <option value="{{ printf "%s/%s/" $basePath .id | relLangURL }}">
          {{ .title }} ({{ .abbrev }})
        </option>
          {{ end }}
        {{ end }}
      </select>
    </div>

    <section class="grid-2 mt-3" id="bibles-grid">
      {{/* Generate cards from data, only for bibles with auxiliary data */}}
      {{ range .Site.Data.bibles.bibles }}
        {{ $hasAuxData := index $.Site.Data.bibles_auxiliary .id }}
        {{ if $hasAuxData }}
      <a href="{{ printf "%s/%s/" $basePath .id | relLangURL }}" class="card" data-tags="{{ delimit .tags "," | urlize }}">
        <h2 class="card__title">{{ .title }}</h2>
        {{ with .description }}
        <p class="card__meta">{{ . }}</p>
        {{ end }}
        <div class="row mt-1">
          {{ with .language }}
          <span class="badge">{{ . }}</span>
          {{ end }}
          {{ with .license }}
          <span class="badge" title="License: {{ . }}" data-license="{{ . }}">{{ . }}</span>
          {{ end }}
          {{ range .tags }}
          <span class="badge">{{ . }}</span>
          {{ end }}
        </div>
      </a>
        {{ end }}
      {{ end }}
    </section>

    <p id="no-results" class="hidden center mt-2">{{ i18n "noBiblesMatch" | default "No Bibles match this filter." }}</p>

    <!-- Back navigation -->
    <footer class="actions">
      {{ with .Site.Params.michael.backLink }}
      <a href="{{ . }}" class="btn">
        &larr; {{ i18n "backToReligion" | default "Back" }}
      </a>
      {{ end }}
    </footer>
  </div>
</main>

<script>
(function() {
  'use strict';

  function filterBibles(tag) {
    var cards = document.querySelectorAll('#bibles-grid .card');
    var buttons = document.querySelectorAll('#bible-filters button');
    var noResults = document.getElementById('no-results');
    var visibleCount = 0;

    // Update button states and aria-pressed
    buttons.forEach(function(btn) {
      var isActive = btn.dataset.tag === tag;
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      btn.classList.toggle('is-active', isActive);
    });

    // Filter cards
    cards.forEach(function(card) {
      var cardTags = card.dataset.tags.toLowerCase();
      if (tag === 'all' || cardTags.includes(tag.toLowerCase())) {
        card.style.display = '';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // Show/hide no results message
    if (visibleCount === 0) {
      noResults.classList.remove('hidden');
    } else {
      noResults.classList.add('hidden');
    }
  }

  // Event delegation for filter buttons
  var bibleFilters = document.getElementById('bible-filters');
  if (bibleFilters) {
    bibleFilters.addEventListener('click', function(e) {
      var button = e.target.closest('button');
      if (button && button.dataset.tag) {
        filterBibles(button.dataset.tag);
      }
    });
  }

  // Tag and license badge clicks on bible cards
  var biblesGrid = document.getElementById('bibles-grid');
  if (biblesGrid) {
    // Get the base URL from the page's language prefix
    var basePath = document.documentElement.lang ? '/' + document.documentElement.lang : '';
    biblesGrid.addEventListener('click', function(e) {
      // Handle license badge clicks - navigate to license page
      var badge = e.target.closest('[data-license]');
      if (badge && badge.dataset.license) {
        e.preventDefault();
        e.stopPropagation();
        // Convert license name to URL slug (lowercase, replace spaces/punctuation with hyphens)
        var slug = badge.dataset.license.toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '');
        window.location.href = basePath + '/licenses/' + slug + '/';
      }
    });
  }
})();
</script>
{{ end }}
