{{ define "main" }}
<main class="container">
  <header class="michael-header">
    <h1 class="font-hand">
      {{ i18n "bibles" | default "Bibles" }}
    </h1>
    <p class="font-hand">
      {{ i18n "biblesDescription" | default "Browse available Bible translations" }}
    </p>

    <!-- Quick actions -->
    <nav class="actions btn-group">
      {{ $basePath := .Site.Params.michael.basePath | default "/religion/bibles" }}
      <a href="{{ printf "%s/search/" $basePath | relLangURL }}" role="button">
        {{ i18n "searchBible" | default "Search Bible" }}
      </a>
      <a href="{{ printf "%s/compare/" $basePath | relLangURL }}" role="button" class="secondary">
        {{ i18n "compareTranslations" | default "Compare Translations" }}
      </a>
    </nav>

    <!-- Filter by tag -->
    {{/* Build unique tags from all bibles */}}
    {{ $allTags := slice }}
    {{ range .Site.Data.bibles.bibles }}
      {{ range .tags }}
        {{ $allTags = $allTags | append . }}
      {{ end }}
    {{ end }}
    {{ $uniqueTags := $allTags | uniq | sort }}

    <div class="filter-group" id="bible-filters" role="group" aria-label="{{ i18n "filterByTag" | default "Filter by Tag" }}">
      <button
        type="button"
        data-tag="all"
        aria-pressed="true">
        {{ i18n "all" | default "All" }}
      </button>
      {{ range $uniqueTags }}
      <button
        type="button"
        data-tag="{{ . | urlize }}"
        aria-pressed="false">
        {{ . }}
      </button>
      {{ end }}
    </div>
  </header>

  <!-- Quick navigation -->
  {{ $basePath := .Site.Params.michael.basePath | default "/religion/bibles" }}
  <nav class="bible-nav" aria-label="{{ i18n "bibleNavigation" | default "Bible Navigation" }}">
    <div class="nav-controls">
      <!-- Bible selector -->
      <label class="sr-only" for="bible-select">{{ i18n "selectBible" | default "Select Bible" }}</label>
      <select id="bible-select"
              onchange="if(this.value) window.location.href=this.value">
        <option value="" selected disabled>{{ i18n "selectBible" | default "Select Bible" }}</option>
        {{ range .Site.Data.bibles.bibles }}
          {{/* Only show bibles that have auxiliary data */}}
          {{ $hasAuxData := index $.Site.Data.bibles_auxiliary .id }}
          {{ if $hasAuxData }}
        <option value="{{ printf "%s/%s/" $basePath .id | relLangURL }}">
          {{ .title }} ({{ .abbrev }})
        </option>
          {{ end }}
        {{ end }}
      </select>
    </div>
  </nav>

  <section class="grid-2" id="bibles-grid">
    {{/* Generate cards from data, only for bibles with auxiliary data */}}
    {{ range .Site.Data.bibles.bibles }}
      {{ $hasAuxData := index $.Site.Data.bibles_auxiliary .id }}
      {{ if $hasAuxData }}
    <article>
      <a href="{{ printf "%s/%s/" $basePath .id | relLangURL }}" class="bible-card" data-tags="{{ delimit .tags "," | urlize }}">
        <h2 class="font-hand">{{ .title }}</h2>
        {{ with .description }}
        <p class="font-hand">{{ . }}</p>
        {{ end }}
        <div class="tags">
          {{ with .language }}
          <span class="tag tag-primary">{{ . }}</span>
          {{ end }}
          {{ with .license }}
          <span class="tag tag-license" title="License: {{ . }}" data-license="{{ . }}">{{ . }}</span>
          {{ end }}
          {{ range .tags }}
          <span class="tag tag-accent" data-tag="{{ . | urlize }}">{{ . }}</span>
          {{ end }}
        </div>
      </a>
    </article>
      {{ end }}
    {{ end }}
  </section>

  <p id="no-results" class="font-hand hidden">{{ i18n "noBiblesMatch" | default "No Bibles match this filter." }}</p>

  <!-- Back navigation -->
  <footer class="actions">
    {{ with .Site.Params.michael.backLink }}
    <a href="{{ . }}" role="button" class="secondary">
      &larr; {{ i18n "backToReligion" | default "Back" }}
    </a>
    {{ end }}
  </footer>
</main>

<script>
(function() {
  'use strict';

  function filterBibles(tag) {
    var cards = document.querySelectorAll('.bible-card');
    var buttons = document.querySelectorAll('.filter-group button');
    var noResults = document.getElementById('no-results');
    var visibleCount = 0;

    // Update button states and aria-pressed
    buttons.forEach(function(btn) {
      var isActive = btn.dataset.tag === tag;
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });

    // Filter cards - hide the parent article element
    cards.forEach(function(card) {
      var cardTags = card.dataset.tags.toLowerCase();
      var article = card.closest('article');
      if (tag === 'all' || cardTags.includes(tag.toLowerCase())) {
        article.style.display = '';
        visibleCount++;
      } else {
        article.style.display = 'none';
      }
    });

    // Show/hide no results message
    if (visibleCount === 0) {
      noResults.classList.remove('hidden');
    } else {
      noResults.classList.add('hidden');
    }
  }

  // Event delegation for filter buttons
  var bibleFilters = document.getElementById('bible-filters');
  if (bibleFilters) {
    bibleFilters.addEventListener('click', function(e) {
      var button = e.target.closest('button');
      if (button && button.dataset.tag) {
        filterBibles(button.dataset.tag);
      }
    });
  }

  // Tag and license badge clicks on bible cards
  var biblesGrid = document.getElementById('bibles-grid');
  if (biblesGrid) {
    // Get the base URL from the page's language prefix
    var basePath = document.documentElement.lang ? '/' + document.documentElement.lang : '';
    biblesGrid.addEventListener('click', function(e) {
      // Handle tag-accent clicks - filter by tag
      var tagBadge = e.target.closest('.tag-accent');
      if (tagBadge && tagBadge.dataset.tag) {
        e.preventDefault();
        e.stopPropagation();
        filterBibles(tagBadge.dataset.tag);
        return;
      }

      // Handle license badge clicks - navigate to license page
      var badge = e.target.closest('.tag-license');
      if (badge && badge.dataset.license) {
        e.preventDefault();
        e.stopPropagation();
        // Convert license name to URL slug (lowercase, replace spaces/punctuation with hyphens)
        var slug = badge.dataset.license.toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '');
        window.location.href = basePath + '/licenses/' + slug + '/';
      }
    });
  }
})();
</script>
{{ end }}
