{{ define "scripts" }}
{{ if .Params.chapter }}
<!-- Strong's number tooltips for Bible text -->
{{ $strongs := resources.Get "js/strongs.js" }}
{{ if $strongs }}
<script src="{{ $strongs.RelPermalink }}" defer></script>
{{ end }}
<!-- Verse sharing functionality -->
{{ $share := resources.Get "js/share.js" }}
{{ if $share }}
<script src="{{ $share.RelPermalink }}" defer></script>
{{ end }}
{{ end }}
{{ end }}

{{ define "main" }}
{{ $basePath := .Site.Params.michael.basePath | default "/religion/bibles" }}
<main class="container" style="padding: var(--pad-3) var(--pad-2);">
  <article class="panel">
    <header class="page-header">
      <h1>{{ .Title }}</h1>
      {{ with .Params.description }}
      <p>{{ . }}</p>
      {{ end }}

      <!-- Features/tags -->
      <div class="row mt-1" style="justify-content: center;">
        {{/* Get language and license from Bible's _index.md (pre-computed) */}}
        {{ $bibleIndex := .Site.GetPage (printf "%s/%s" $basePath .Params.bible) }}
        {{ with $bibleIndex.Params.language }}
        <span class="badge">{{ . }}</span>
        {{ end }}
        {{ with $bibleIndex.Params.license }}
        <a href="{{ printf "/licenses/%s/" (. | urlize) | relLangURL }}" class="badge" title="SPDX License: {{ . }}">{{ . }}</a>
        {{ end }}
        {{ range .Params.features }}
        <span class="badge">{{ . }}</span>
        {{ end }}
      </div>
    </header>

    <!-- Bible chapter content or book navigation -->
    {{ if .Params.chapter }}
      <!-- Chapter view: show verses -->
      <section>
        {{/* Cache bible-nav since it's rendered twice (top and bottom) with identical output */}}
        {{ $navKey := printf "%s-%s-%d-%d" .Params.bible .Params.book .Params.chapter (.Params.chapterCount | default 0) }}
        {{ $navParams := dict "page" . "bible" .Params.bible "book" .Params.book "chapter" .Params.chapter "basePath" $basePath }}
        {{ $cachedNav := partialCached "michael/bible-nav.html" $navParams $navKey }}

        <!-- Navigation with dropdowns -->
        {{ $cachedNav }}

        <div class="prose">
          {{ .Content }}
        </div>

        <!-- Bottom navigation for convenience -->
        {{ $cachedNav }}
      </section>

    {{ else if .Params.book }}
      <!-- Book view: show chapter list -->
      <section>
        {{ partial "michael/bible-nav.html" (dict "page" . "bible" .Params.bible "book" .Params.book "chapter" 0 "basePath" $basePath) }}
        <div class="prose">
          {{ .Content | safeHTML }}
        </div>
      </section>

    {{ else if .Params.bible }}
      <!-- Bible overview: show book list -->
      <section>
        {{ partial "michael/bible-nav.html" (dict "page" . "bible" .Params.bible "book" "" "chapter" 0 "basePath" $basePath) }}
        <div class="prose">
          {{ .Content | safeHTML }}
        </div>
      </section>
    {{ else }}
      <!-- Bibles list page (no specific bible) - show data-driven bible cards -->

      <!-- Quick actions -->
      <nav class="actions">
        <a href="{{ printf "%s/search/" $basePath | relLangURL }}" class="btn btn--primary">
          {{ i18n "searchBible" | default "Search Bible" }}
        </a>
      </nav>

      <!-- Filter by tag -->
      {{/* Build unique tags from all bibles */}}
      {{ $allTags := slice }}
      {{ range .Site.Data.bibles.bibles }}
        {{ range .tags }}
          {{ $allTags = $allTags | append . }}
        {{ end }}
      {{ end }}
      {{ $uniqueTags := $allTags | uniq | sort }}

      <div class="row mt-2" id="bible-filters" role="group" aria-label="{{ i18n "filterByTag" | default "Filter by Tag" }}" style="justify-content: center;">
        <button
          type="button"
          class="chip is-active"
          data-tag="all"
          aria-pressed="true">
          {{ i18n "all" | default "All" }}
        </button>
        {{ range $uniqueTags }}
        <button
          type="button"
          class="chip"
          data-tag="{{ . | urlize }}"
          aria-pressed="false">
          {{ . }}
        </button>
        {{ end }}
      </div>

      <!-- Quick navigation dropdown -->
      <div class="row mt-2" style="justify-content: center;">
        <label class="sr-only" for="bible-select">{{ i18n "selectBible" | default "Select Bible" }}</label>
        <select id="bible-select"
                class="select"
                style="width: auto;"
                onchange="if(this.value) window.location.href=this.value">
          <option value="" selected disabled>{{ i18n "selectBible" | default "Select Bible" }}</option>
          {{ range .Site.Data.bibles.bibles }}
            {{/* Only show bibles that have auxiliary data */}}
            {{ $hasAuxData := index $.Site.Data.bibles_auxiliary .id }}
            {{ if $hasAuxData }}
          <option value="{{ printf "%s/%s/" $basePath .id | relLangURL }}">
            {{ .title }} ({{ .abbrev }})
          </option>
            {{ end }}
          {{ end }}
        </select>
      </div>

      <section class="grid-2 mt-3" id="bibles-grid">
        {{/* Generate cards from data, only for bibles with auxiliary data */}}
        {{ range .Site.Data.bibles.bibles }}
          {{ $hasAuxData := index $.Site.Data.bibles_auxiliary .id }}
          {{ if $hasAuxData }}
        <a href="{{ printf "%s/%s/" $basePath .id | relLangURL }}" class="card" data-tags="{{ delimit .tags "," | urlize }}">
          <h2 class="card__title">{{ .title }}</h2>
          {{ with .description }}
          <p class="card__meta">{{ . }}</p>
          {{ end }}
          <div class="row mt-1">
            {{ with .language }}
            <span class="badge">{{ . }}</span>
            {{ end }}
            {{ with .license }}
            <span class="badge" title="License: {{ . }}" data-license="{{ . }}">{{ . }}</span>
            {{ end }}
            {{ range .tags }}
            <span class="badge">{{ . }}</span>
            {{ end }}
          </div>
        </a>
          {{ end }}
        {{ end }}
      </section>

      <p id="no-results" class="hidden center mt-2">{{ i18n "noBiblesMatch" | default "No Bibles match this filter." }}</p>
    {{ end }}

    <!-- Navigation -->
    <nav class="actions">
      {{ if .Params.chapter }}
        <a href="{{ printf "%s/%s/%s/" $basePath .Params.bible .Params.book | relLangURL }}" class="btn">
          &larr; {{ i18n "backToBook" | default "Back to Book" }}
        </a>
      {{ else if .Params.book }}
        <a href="{{ printf "%s/%s/" $basePath .Params.bible | relLangURL }}" class="btn">
          &larr; {{ i18n "backToBible" | default "Back to Bible" }}
        </a>
      {{ else if .Params.bible }}
        <a href="{{ printf "%s/" $basePath | relLangURL }}" class="btn">
          &larr; {{ i18n "allBibles" | default "All Bibles" }}
        </a>
      {{/* No navigation shown for the bibles list page itself */}}
      {{ end }}
    </nav>
  </article>
</main>
{{ end }}
