{{/*
  Template: baseof.html
  Purpose: Base HTML template for all pages

  Blocks:
  - "main": Page content
  - "scripts": Page-specific JavaScript

  Security:
  - CSP meta tag restricts resource loading
  - unsafe-inline required for Hugo's style fingerprinting

  Note: For production with custom domains, consider moving CSP to HTTP headers
*/}}
<!doctype html>
<html lang="{{ .Site.Language.Lang | default "en" }}" data-hugo-env="{{ hugo.Environment }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  {{/* Early PWA standalone detection - must run before body renders */}}
  <script>
    (function() {
      // Detect PWA standalone mode early and add class to html element
      // This runs before body exists, so we add to documentElement (html)
      var isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                         window.matchMedia('(display-mode: fullscreen)').matches ||
                         window.matchMedia('(display-mode: minimal-ui)').matches ||
                         window.navigator.standalone === true ||
                         document.referrer.includes('android-app://');
      if (isStandalone) {
        document.documentElement.classList.add('pwa-standalone');
      }
    })();
  </script>
  <title>{{- if .IsHome -}}{{ .Site.Title }}{{- else -}}{{ .Title }} | {{ .Site.Title }}{{- end -}}</title>
  <meta name="description" content="{{ with .Description }}{{ . }}{{ else }}{{ with .Summary }}{{ . | plainify }}{{ else }}{{ .Site.Params.description }}{{ end }}{{ end }}">
  {{/* Content Security Policy - restrictive by default */}}
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; font-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';">
  {{ with .Permalink }}<link rel="canonical" href="{{ . }}">{{ end }}
  {{ with .OutputFormats.Get "rss" }}<link rel="alternate" type="application/rss+xml" title="{{ $.Site.Title }}" href="{{ .Permalink }}">{{ end }}
  {{- template "_internal/opengraph.html" . -}}
  {{- template "_internal/twitter_cards.html" . -}}

  {{/* Focus with Justin â€” Starter Theme */}}
  {{ $theme := resources.Get "css/theme.css" | minify | fingerprint }}
  <link rel="stylesheet" href="{{ $theme.RelPermalink }}" integrity="{{ $theme.Data.Integrity }}">

  {{/* PWA Support */}}
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#7a00b0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Michael">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16.png">
</head>
<body>
  {{ partial "header.html" . }}

  {{ block "main" . }}{{ end }}

  {{ partial "footer.html" . }}

  {{/* Page-specific scripts */}}
  {{ block "scripts" . }}{{ end }}

  {{/* Service Worker registration */}}
  {{ partial "michael/sw-register.html" . }}

  {{/* PWA Core Scripts */}}
  {{ $userStorage := resources.Get "js/michael/user-storage.js" }}
  {{ if $userStorage }}<script src="{{ $userStorage.RelPermalink }}" defer></script>{{ end }}
  {{ $readingTracker := resources.Get "js/michael/reading-tracker.js" }}
  {{ if $readingTracker }}<script src="{{ $readingTracker.RelPermalink }}" defer></script>{{ end }}

  {{/* PWA Install Banner */}}
  {{ partial "michael/pwa-install-banner.html" . }}

  {{/* Detect PWA standalone mode - also add to body for CSS specificity */}}
  <script>
    (function() {
      var isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                         window.matchMedia('(display-mode: fullscreen)').matches ||
                         window.matchMedia('(display-mode: minimal-ui)').matches ||
                         window.navigator.standalone === true ||
                         document.referrer.includes('android-app://');
      if (isStandalone) {
        document.body.classList.add('pwa-standalone');
      }
    })();
  </script>
</body>
</html>
