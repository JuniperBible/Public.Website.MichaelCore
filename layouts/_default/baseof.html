{{/*
  Template: baseof.html
  Purpose: Base HTML template for all pages

  Blocks:
  - "main": Page content
  - "scripts": Page-specific JavaScript

  Security:
  - CSP meta tag restricts resource loading
  - unsafe-inline required for Hugo's style fingerprinting

  Note: For production with custom domains, consider moving CSP to HTTP headers
*/}}
<!doctype html>
<html lang="{{ .Site.Language.Lang | default "en" }}" data-hugo-env="{{ hugo.Environment }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  {{/* Early PWA standalone detection - must run before body renders */}}
  <script>
    (function() {
      // Detect PWA standalone mode using multiple methods
      var displayModes = ['standalone', 'fullscreen', 'minimal-ui', 'window-controls-overlay'];
      var isStandalone = false;

      // Check all display modes
      for (var i = 0; i < displayModes.length; i++) {
        if (window.matchMedia('(display-mode: ' + displayModes[i] + ')').matches) {
          isStandalone = true;
          break;
        }
      }

      // iOS Safari standalone
      if (window.navigator.standalone === true) {
        isStandalone = true;
      }

      // Android TWA
      if (document.referrer.includes('android-app://')) {
        isStandalone = true;
      }

      // Check if opened from home screen (no browser UI visible)
      // This is a heuristic: if window.outerHeight equals window.innerHeight, likely no browser chrome
      if (!isStandalone && window.outerHeight && window.innerHeight) {
        var heightDiff = window.outerHeight - window.innerHeight;
        // If difference is very small (< 100px), likely no URL bar = PWA mode
        if (heightDiff < 100 && heightDiff >= 0) {
          isStandalone = true;
        }
      }

      if (isStandalone) {
        document.documentElement.classList.add('pwa-standalone');
      }
    })();
  </script>
  <title>{{- if .IsHome -}}{{ .Site.Title }}{{- else -}}{{ .Title }} | {{ .Site.Title }}{{- end -}}</title>
  <meta name="description" content="{{ with .Description }}{{ . }}{{ else }}{{ with .Summary }}{{ . | plainify }}{{ else }}{{ .Site.Params.description }}{{ end }}{{ end }}">
  {{/* Content Security Policy - restrictive by default */}}
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; font-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';">
  {{ with .Permalink }}<link rel="canonical" href="{{ . }}">{{ end }}
  {{ with .OutputFormats.Get "rss" }}<link rel="alternate" type="application/rss+xml" title="{{ $.Site.Title }}" href="{{ .Permalink }}">{{ end }}
  {{- template "_internal/opengraph.html" . -}}
  {{- template "_internal/twitter_cards.html" . -}}

  {{/* Focus with Justin â€” Starter Theme */}}
  {{ $theme := resources.Get "css/theme.css" | minify | fingerprint }}
  <link rel="stylesheet" href="{{ $theme.RelPermalink }}" integrity="{{ $theme.Data.Integrity }}">

  {{/* PWA Support */}}
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#7a00b0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Michael">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16.png">
</head>
<body>
  {{ partial "header.html" . }}

  {{ block "main" . }}{{ end }}

  {{ partial "footer.html" . }}

  {{/* Page-specific scripts */}}
  {{ block "scripts" . }}{{ end }}

  {{/* Service Worker registration */}}
  {{ partial "michael/sw-register.html" . }}

  {{/* PWA Core Scripts */}}
  {{ $userStorage := resources.Get "js/michael/user-storage.js" }}
  {{ if $userStorage }}<script src="{{ $userStorage.RelPermalink }}" defer></script>{{ end }}
  {{ $readingTracker := resources.Get "js/michael/reading-tracker.js" }}
  {{ if $readingTracker }}<script src="{{ $readingTracker.RelPermalink }}" defer></script>{{ end }}

  {{/* PWA Install Banner */}}
  {{ partial "michael/pwa-install-banner.html" . }}

  {{/* Detect PWA standalone mode - also add to body for CSS specificity */}}
  <script>
    (function() {
      // If html already has the class, add to body too
      if (document.documentElement.classList.contains('pwa-standalone')) {
        document.body.classList.add('pwa-standalone');
        return;
      }

      // Re-check in case it wasn't detected earlier
      var displayModes = ['standalone', 'fullscreen', 'minimal-ui', 'window-controls-overlay'];
      var isStandalone = false;

      for (var i = 0; i < displayModes.length; i++) {
        if (window.matchMedia('(display-mode: ' + displayModes[i] + ')').matches) {
          isStandalone = true;
          break;
        }
      }

      if (window.navigator.standalone === true) isStandalone = true;
      if (document.referrer.includes('android-app://')) isStandalone = true;

      // Height heuristic for PWA mode
      if (!isStandalone && window.outerHeight && window.innerHeight) {
        var heightDiff = window.outerHeight - window.innerHeight;
        if (heightDiff < 100 && heightDiff >= 0) isStandalone = true;
      }

      if (isStandalone) {
        document.documentElement.classList.add('pwa-standalone');
        document.body.classList.add('pwa-standalone');
      }
    })();
  </script>
</body>
</html>
