{{ define "main" }}
{{- $softwareDeps := .Site.Data.software_deps -}}
{{- $allBibles   := partialCached "michael/bible-data.html" .Site -}}
<main class="container pad-3-2">
  <div class="panel">
    <header class="page-header">
      <h1>{{ .Title }}</h1>
      <p>{{ i18n "sbomDescription" | default "Software Bill of Materials (SBOM) for Bible translations and software dependencies" }}</p>
    </header>

    <!-- SBOM Summary -->
    <section class="panel--inner license-section">
      <h2 class="mt-0">{{ i18n "sbomSummary" | default "SBOM Summary" }}</h2>
      <div class="row row--wrap gap-2">
        <div>
          <strong>{{ len $allBibles }}</strong> {{ i18n "bibles" | default "Bible Translations" }}
        </div>
        <div>
          <strong>{{ len .Pages }}</strong> {{ i18n "uniqueLicenses" | default "Unique Licenses" }}
        </div>
        {{ with $softwareDeps }}
        <div><strong>{{ len .tools }}</strong> {{ i18n "buildTools" | default "Build Tools" }}</div>
        <div><strong>{{ len .libraries }}</strong> {{ i18n "libraries" | default "Libraries" }}</div>
        <div><strong>{{ len .data_sources }}</strong> {{ i18n "dataSources" | default "Data Sources" }}</div>
        {{ end }}
        <div>
          {{ i18n "generated" | default "Generated" }}: <code>{{ now.Format "2006-01-02" }}</code>
        </div>
      </div>
    </section>

    <!-- Software Dependencies Section -->
    {{ with $softwareDeps }}
    <section class="panel--inner license-section">
      <h2 class="mt-0">{{ i18n "softwareDependencies" | default "Software Dependencies" }}</h2>
      {{ partial "michael/dep-table.html" (dict "heading" "buildTools"  "default" "Build Tools"  "items" .tools) }}
      {{ partial "michael/dep-table.html" (dict "heading" "libraries"   "default" "Libraries"    "items" .libraries) }}
      {{ partial "michael/dep-table.html" (dict "heading" "dataSources" "default" "Data Sources" "items" .data_sources) }}
    </section>
    {{ end }}

    <!-- Bible License breakdown -->
    <h2>{{ i18n "bibleTranslationLicenses" | default "Bible Translation Licenses" }}</h2>
    {{ range .Pages }}
    {{- $bibles := where $allBibles "license" .Params.licenseId -}}
    <section class="panel--inner license-section">
      <div class="row row--space-between gap-1">
        <div>
          <h3 class="mt-0 mb-0">
            <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          </h3>
          <p class="muted mt-xs mb-0">
            SPDX: <code>{{ .Params.licenseId }}</code>
            {{ with .Params.isOsiApproved }}<span class="badge badge--success ml-1">OSI Approved</span>{{ end }}
          </p>
        </div>
        <div>
          <a href="{{ .RelPermalink }}" class="btn btn--sm">
            {{ i18n "viewDetails" | default "View Details" }}
          </a>
        </div>
      </div>

      {{ with $bibles }}
      <div class="mt-1">
        <table class="license-table">
          <thead>
            <tr>
              <th>{{ i18n "tableTranslation" | default "Translation" }}</th>
              <th>{{ i18n "abbreviation" | default "Abbreviation" }}</th>
              <th>{{ i18n "language" | default "Language" }}</th>
            </tr>
          </thead>
          <tbody>
            {{ range . }}
            <tr>
              <td><a href="{{ printf "/bible/%s/" .id | relLangURL }}">{{ .title }}</a></td>
              <td><code>{{ .abbrev }}</code></td>
              <td><span class="badge">{{ .language }}</span></td>
            </tr>
            {{ end }}
          </tbody>
        </table>
      </div>
      {{ end }}
    </section>
    {{ end }}

    <!-- Export options -->
    <section class="panel--inner license-section">
      <h3 class="mt-0">{{ i18n "exportSbom" | default "Export SBOM" }}</h3>
      <p class="muted">{{ i18n "exportSbomDescription" | default "Download the full Software Bill of Materials in standard formats:" }}</p>
      <div class="row row--wrap gap-1">
        <a href="/downloads/sbom/sbom.spdx.json" class="btn btn--secondary" download>SPDX JSON</a>
        <a href="/downloads/sbom/sbom.cdx.json" class="btn btn--secondary" download>CycloneDX JSON</a>
        <a href="/downloads/sbom/sbom.cdx.xml" class="btn btn--secondary" download>CycloneDX XML</a>
        <a href="/downloads/sbom/sbom.syft.json" class="btn btn--secondary" download>Syft JSON</a>
      </div>
    </section>

    <nav class="actions">
      <a href="/bible/" class="btn">
        &larr; {{ i18n "allBibles" | default "All Bibles" }}
      </a>
    </nav>
  </div>
</main>
{{ end }}
