{{ define "main" }}
{{- $softwareDeps := .Site.Data.software_deps -}}
<main class="container pad-3-2">
  <div class="panel">
    <header class="page-header">
      <h1>{{ .Title }}</h1>
      <p>Software Bill of Materials (SBOM) for Bible translations and software dependencies</p>
    </header>

    <!-- SBOM Summary -->
    <section class="panel--inner license-section">
      <h2 class="mt-0">SBOM Summary</h2>
      <div class="row gap-2" style="flex-wrap: wrap;">
        <div>
          <strong>{{ len (partialCached "michael/bible-data.html" .Site) }}</strong> Bible Translations
        </div>
        <div>
          <strong>{{ len .Pages }}</strong> Unique Licenses
        </div>
        {{ with $softwareDeps }}
        <div>
          <strong>{{ len .tools }}</strong> Build Tools
        </div>
        <div>
          <strong>{{ len .libraries }}</strong> Libraries
        </div>
        <div>
          <strong>{{ len .data_sources }}</strong> Data Sources
        </div>
        {{ end }}
        <div>
          Generated: <code>{{ now.Format "2006-01-02" }}</code>
        </div>
      </div>
    </section>

    <!-- Software Dependencies Section -->
    {{ with $softwareDeps }}
    <section class="panel--inner license-section">
      <h2 class="mt-0">Software Dependencies</h2>

      {{ with .tools }}
      <h3>Build Tools</h3>
      <table class="license-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Version</th>
            <th>License</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {{ range . }}
          <tr>
            <td>
              <a href="{{ .downloadLocation }}" target="_blank" rel="noopener">{{ .name }}</a>
            </td>
            <td><code>{{ .version }}</code></td>
            <td><span class="badge">{{ .license }}</span></td>
            <td>{{ .description }}</td>
          </tr>
          {{ end }}
        </tbody>
      </table>
      {{ end }}

      {{ with .libraries }}
      <h3>Libraries</h3>
      <table class="license-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Version</th>
            <th>License</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {{ range . }}
          <tr>
            <td>
              <a href="{{ .downloadLocation }}" target="_blank" rel="noopener">{{ .name }}</a>
            </td>
            <td><code>{{ .version }}</code></td>
            <td><span class="badge">{{ .license }}</span></td>
            <td>{{ .description }}</td>
          </tr>
          {{ end }}
        </tbody>
      </table>
      {{ end }}

      {{ with .data_sources }}
      <h3>Data Sources</h3>
      <table class="license-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Version</th>
            <th>License</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {{ range . }}
          <tr>
            <td>
              <a href="{{ .downloadLocation }}" target="_blank" rel="noopener">{{ .name }}</a>
            </td>
            <td><code>{{ .version }}</code></td>
            <td><span class="badge">{{ .license }}</span></td>
            <td>{{ .description }}</td>
          </tr>
          {{ end }}
        </tbody>
      </table>
      {{ end }}
    </section>
    {{ end }}

    <!-- Bible License breakdown -->
    <h2>Bible Translation Licenses</h2>
    {{ range .Pages }}
    {{ $licenseId := .Params.licenseId }}
    {{ $bibles := slice }}
    {{ range (partialCached "michael/bible-data.html" $.Site) }}
      {{ if eq .license $licenseId }}
        {{ $bibles = $bibles | append . }}
      {{ end }}
    {{ end }}

    <section class="panel--inner license-section">
      <div class="row row--space-between gap-1">
        <div>
          <h3 style="margin: 0;">
            <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          </h3>
          <p class="muted" style="margin: 4px 0 0 0;">
            SPDX: <code>{{ .Params.licenseId }}</code>
            {{ if .Params.isOsiApproved }}
            <span class="badge badge--success" style="margin-left: 8px;">OSI Approved</span>
            {{ end }}
          </p>
        </div>
        <div>
          <a href="{{ .RelPermalink }}" class="btn btn--sm">
            View Details
          </a>
        </div>
      </div>

      {{ if $bibles }}
      <div class="mt-1">
        <table class="license-table">
          <thead>
            <tr>
              <th>Translation</th>
              <th>Abbreviation</th>
              <th>Language</th>
            </tr>
          </thead>
          <tbody>
            {{ range $bibles }}
            <tr>
              <td>
                <a href="{{ printf "/bible/%s/" .id | relLangURL }}">{{ .title }}</a>
              </td>
              <td><code>{{ .abbrev }}</code></td>
              <td><span class="badge">{{ .language }}</span></td>
            </tr>
            {{ end }}
          </tbody>
        </table>
      </div>
      {{ end }}
    </section>
    {{ end }}

    <!-- Export options -->
    <section class="panel--inner license-section">
      <h3 class="mt-0">Export SBOM</h3>
      <p class="muted">Download the full Software Bill of Materials in standard formats:</p>
      <div class="row gap-1" style="flex-wrap: wrap;">
        <a href="/downloads/sbom/sbom.spdx.json" class="btn btn--secondary" download>
          SPDX JSON
        </a>
        <a href="/downloads/sbom/sbom.cdx.json" class="btn btn--secondary" download>
          CycloneDX JSON
        </a>
        <a href="/downloads/sbom/sbom.cdx.xml" class="btn btn--secondary" download>
          CycloneDX XML
        </a>
        <a href="/downloads/sbom/sbom.syft.json" class="btn btn--secondary" download>
          Syft JSON
        </a>
      </div>
    </section>

    <nav class="actions">
      <a href="/bible/" class="btn">
        &larr; All Bibles
      </a>
    </nav>
  </div>
</main>
{{ end }}
