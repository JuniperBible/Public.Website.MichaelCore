/**
 * Bible Navigation Handler
 *
 * Handles dropdown navigation for Bible translation, book, and chapter selectors.
 * The Bible selector preserves book/chapter context when switching translations,
 * showing a "not available" message if the target content doesn't exist.
 */
'use strict';

window.Michael = window.Michael || {};

/**
 * Allowed base paths for Bible navigation (whitelist)
 * @type {string[]}
 */
const ALLOWED_BASE_PATHS = ['/bible', '/biblia', '/bibles'];

/**
 * Validate that a base path is in the allowed whitelist
 * @param {string} basePath - The base path to validate
 * @returns {string} The validated base path, or '/bible' as default
 */
function getValidBasePath(basePath) {
  if (ALLOWED_BASE_PATHS.includes(basePath)) {
    return basePath;
  }
  return '/bible';
}

/**
 * Validate that an ID contains only safe characters
 * @param {string} id - The ID to validate
 * @param {RegExp} pattern - Pattern to match against
 * @returns {boolean} True if valid
 */
function isValidId(id, pattern) {
  return id && typeof id === 'string' && pattern.test(id);
}

/**
 * Build a safe internal URL from validated components
 * @param {string} basePath - Validated base path
 * @param {string} bibleId - Validated Bible ID
 * @param {string} [book] - Optional validated book ID
 * @param {string} [chapter] - Optional validated chapter number
 * @returns {string} Constructed URL path
 */
function buildBibleUrl(basePath, bibleId, book, chapter) {
  var safePath = getValidBasePath(basePath);
  var url = safePath + '/' + bibleId + '/';
  if (book) {
    url += book + '/';
  }
  if (book && chapter) {
    url += chapter + '/';
  }
  return url;
}

function initBibleNav() {
  const navs = document.querySelectorAll('.bible-nav');

  navs.forEach(function(nav) {
    const bibleSelect = nav.querySelector('#bible-select');
    const bookSelect = nav.querySelector('#book-select');
    const chapterSelect = nav.querySelector('#chapter-select');

    // Bible selector — preserve book/chapter context
    if (bibleSelect) {
      bibleSelect.addEventListener('change', function() {
        var bibleId = this.value;
        if (!bibleId) return;

        // Validate bibleId contains only safe characters (alphanumeric, hyphens)
        if (!isValidId(bibleId, /^[a-zA-Z0-9-]+$/)) {
          return;
        }

        var basePath = this.dataset.basePath || '/bible';
        var book = this.dataset.book || '';
        var chapter = this.dataset.chapter || '';

        // Validate book and chapter contain only safe characters
        if (book && !isValidId(book, /^[a-zA-Z0-9]+$/)) {
          return;
        }
        if (chapter && !isValidId(chapter, /^[0-9]+$/)) {
          return;
        }

        // Build URL from validated components
        var url = buildBibleUrl(basePath, bibleId, book, chapter);
        var fallbackUrl = buildBibleUrl(basePath, bibleId, '', '');

        // If we have book/chapter context, check if the page exists
        if (book) {
          checkAndNavigate(basePath, bibleId, book, chapter, fallbackUrl, this);
        } else {
          window.location.assign(url);
        }
      });
    }

    // Book and chapter selectors — values come from server-rendered options
    // These are trusted paths generated by Hugo templates
    [bookSelect, chapterSelect].forEach(function(select) {
      if (!select) return;
      select.addEventListener('change', function() {
        var selectedPath = this.value;
        // Validate path starts with allowed base and contains no dangerous patterns
        if (!selectedPath || typeof selectedPath !== 'string') {
          return;
        }
        // Must start with an allowed base path
        var isAllowed = ALLOWED_BASE_PATHS.some(function(base) {
          return selectedPath.startsWith(base + '/');
        });
        if (!isAllowed) {
          return;
        }
        // Reject any absolute URLs or dangerous patterns
        if (/^[a-z][a-z0-9+.-]*:/i.test(selectedPath) || selectedPath.startsWith('//')) {
          return;
        }
        if (selectedPath.includes('..')) {
          return;
        }
        window.location.assign(selectedPath);
      });
    });
  });
}

/**
 * Check if URL exists, navigate there if so, otherwise show unavailable message.
 * Constructs URL internally from validated components to prevent SSRF.
 * @param {string} basePath - Validated base path
 * @param {string} bibleId - Validated Bible ID
 * @param {string} book - Validated book ID
 * @param {string} chapter - Validated chapter number
 * @param {string} fallbackUrl - Pre-constructed fallback URL
 * @param {HTMLSelectElement} selectEl - The select element to disable during check
 */
function checkAndNavigate(basePath, bibleId, book, chapter, fallbackUrl, selectEl) {
  // Disable selector during check
  selectEl.disabled = true;

  // Construct URL from validated components (not from user input directly)
  var targetUrl = buildBibleUrl(basePath, bibleId, book, chapter);

  // Fetch using same-origin credentials (URL is constructed from validated parts)
  var fetchUrl = targetUrl;
  fetch(fetchUrl, { method: 'HEAD', credentials: 'same-origin' })
    .then(function(response) {
      if (response.ok) {
        window.location.assign(targetUrl);
      } else {
        showUnavailable(selectEl, targetUrl, fallbackUrl);
      }
    })
    .catch(function() {
      // Network error — try navigating directly
      window.location.assign(targetUrl);
    });
}

/**
 * Show a notice that the content is not available in the selected translation.
 * @param {HTMLSelectElement} selectEl - The select element
 * @param {string} attemptedUrl - The URL that was attempted (for display only)
 * @param {string} fallbackUrl - Fallback URL constructed from validated components
 */
function showUnavailable(selectEl, attemptedUrl, fallbackUrl) {
  selectEl.disabled = false;

  // Extract bible name from the selected option
  var selectedOption = selectEl.options[selectEl.selectedIndex];
  var bibleName = selectedOption ? selectedOption.textContent.trim() : 'this translation';

  // Show message in the content area
  var content = document.getElementById('chapter-content');
  if (content) {
    // Build notice using DOM APIs to avoid innerHTML
    content.textContent = '';
    var notice = document.createElement('div');
    notice.className = 'notice';
    notice.setAttribute('role', 'alert');
    var strong = document.createElement('strong');
    strong.textContent = 'Not available';
    notice.appendChild(strong);
    notice.appendChild(document.createTextNode(' — this book or chapter is not available in ' + bibleName + '. '));
    var link = document.createElement('a');
    link.href = fallbackUrl;
    link.textContent = 'Browse available books';
    notice.appendChild(link);
    notice.appendChild(document.createTextNode('.'));
    content.appendChild(notice);

    content.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } else {
    // No content area — navigate to fallback
    window.location.assign(fallbackUrl);
  }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initBibleNav);
} else {
  initBibleNav();
}

window.Michael.initBibleNav = initBibleNav;
